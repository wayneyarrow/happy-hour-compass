<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy Hour Compass</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* CSS variable for sticky header + chips offset */
        :root {
            --sticky-offset: 146px; /* detail-page-header (56px) + venue-chips-nav (~90px) */
        }

        /* Scroll anchor for section jumps - positions section titles below sticky UI */
        .scroll-anchor {
            position: relative;
            top: calc(-1 * var(--sticky-offset));
            height: 1px;
            visibility: hidden;
            pointer-events: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .phone-frame {
            width: 375px;
            height: 812px;
            background: white;
            border-radius: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
            position: relative;
        }

        .screen {
            display: none;
            height: 100%;
            flex-direction: column;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
        }

        .screen.active {
            display: flex;
        }

        /* ===== SPLASH & HOME SCREEN STYLES ===== */
        .splash-screen {
            background: white;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .home-screen {
            background: white;
            justify-content: flex-start;
            align-items: center;
            flex-direction: column;
            padding-top: 120px;
        }

        .splash-logo {
            width: 220px;
            height: 220px;
            object-fit: contain;
        }

        .home-screen .splash-logo {
            width: 180px;
            height: 180px;
            margin-bottom: 32px;
        }

        .home-tagline {
            font-size: 20px;
            color: #374151;
            text-align: center;
            margin-bottom: 48px;
            font-weight: 500;
            padding: 0 24px;
        }

        .home-cta {
            background: #f97316;
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .home-cta:hover {
            background: #ea580c;
        }

        .home-cta:active {
            background: #c2410c;
        }

        /* Fade transition for splash */
        .splash-screen.fade-out {
            opacity: 0;
            transition: opacity 0.3s ease-out;
        }

        .header {
            background: #3b82f6;
            color: white;
            padding: 50px 20px 20px;
            text-align: center;
            position: relative;
            flex-shrink: 0;
        }

        .detail-page-header {
            background: white;
            padding: 16px 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .detail-back-btn {
            background: none;
            border: none;
            color: #3b82f6;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .detail-page-title {
            font-size: 18px;
            font-weight: bold;
            color: #111827;
            margin: 0;
            flex: 1;
            text-align: left;
            margin-left: 12px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .header-icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            /* Increased padding for better tap target (44px min) */
            padding: 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            /* Ensure minimum comfortable tap target */
            min-width: 44px;
            min-height: 44px;
        }

        .header-icon-btn:hover {
            background: #f3f4f6;
        }

        .header-icon-btn svg {
            width: 22px;
            height: 22px;
        }

        .header-icon-btn svg path {
            fill: #374151;
        }

        /* Bookmark icon in header: outline by default, filled when saved */
        .header-icon-btn.header-bookmark-btn svg path {
            fill: none;
            stroke: #6b7280;
            stroke-width: 2;
        }

        .header-icon-btn.header-bookmark-btn.saved svg path {
            fill: #f97316;
            stroke: #f97316;
        }

        .venue-detail-scroll {
            height: calc(100vh - 57px);
            overflow-y: auto;
            position: relative;
            -webkit-overflow-scrolling: touch;
        }

        .venue-header-collapsible {
            background: white;
            transform-origin: top;
            transition: transform 0.25s ease-out, opacity 0.25s ease-out;
        }

        .venue-header-collapsible.collapsed {
            transform: translateY(-100%);
            opacity: 0;
            pointer-events: none;
        }

        .venue-hero-image {
            width: 100%;
            height: 240px;
            background-size: cover;
            background-position: center;
            background-color: #e5e7eb;
        }

        .venue-name-section {
            padding: 20px 20px 12px;
        }

        .venue-name-large {
            font-size: 24px;
            font-weight: 700;
            color: #111827;
            margin: 0 0 8px 0;
            line-height: 1.2;
            /* Clamp to 2 lines max for long venue names */
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            word-wrap: break-word;
            word-break: break-word;
        }

        .venue-meta-row {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            /* Allow wrapping for long metadata */
            flex-wrap: wrap;
        }

        /* Event venue text (plain text, not clickable) */
        .event-venue-text {
            font-size: 15px;
            font-weight: 500;
            color: #6b7280;
            margin-bottom: 6px;
        }

        .venue-action-buttons {
            display: flex;
            gap: 8px;
            padding: 0 20px 20px;
        }

        .venue-action-btn {
            flex: 1;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            /* Improved padding for comfortable tap target */
            padding: 12px 8px;
            min-height: 64px;
            font-size: 13px;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: background 0.2s, border-color 0.2s;
        }

        .venue-action-btn:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }

        .venue-action-btn svg {
            flex-shrink: 0;
        }

        /* Jump chips navigation - sticky beneath header */
        .venue-section-nav {
            position: sticky;
            top: 0;
            background: white;
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb;
            z-index: 10;
        }

        .venue-nav-label {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .venue-chips-row {
            display: flex;
            gap: 8px;
        }

        /* Chip button styles - pill-shaped navigation */
        .section-nav-item {
            flex: 1;
            background: white;
            border: 1.5px solid #d1d5db;
            border-radius: 20px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .section-nav-item:hover {
            border-color: #9ca3af;
            background: #f9fafb;
        }

        /* Active chip state - filled with blue */
        .section-nav-item.active {
            background: #3b82f6;
            border-color: #3b82f6;
            color: white;
            font-weight: 600;
        }

        .venue-sections {
            background: white;
            /* Increased padding to ensure last content is reachable */
            padding-bottom: 100px;
        }

        .venue-section {
            padding: 20px;
            min-height: 300px;
        }

        .venue-section:last-child {
            padding-bottom: 100px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #111827;
            margin: 0 0 16px 0;
        }

        .venue-info-details {
            display: flex;
            flex-direction: column;
            gap: 0; /* Flat list with dividers */
        }

        /* Flat list row - non-tappable */
        .info-list-row {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            padding: 16px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .info-list-row:last-child {
            border-bottom: none;
        }

        /* Flat list row - tappable action */
        .info-list-row-action {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            /* Comfortable tap target height */
            padding: 18px 0;
            min-height: 60px;
            background: white;
            border: none;
            border-bottom: 1px solid #f3f4f6;
            border-radius: 0;
            text-align: left;
            width: 100%;
            font-family: inherit;
            cursor: pointer;
            transition: background 0.15s;
            margin: 0 -20px;
            padding-left: 20px;
            padding-right: 20px;
        }

        .info-list-row-action:hover {
            background: #f9fafb;
        }

        .info-list-row-action:active {
            background: #f3f4f6;
        }

        .info-list-row-action:last-child {
            border-bottom: none;
        }

        .info-row-label {
            font-size: 11px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            line-height: 1.3;
            margin-bottom: 6px;
        }

        .info-row-content {
            flex: 1;
            /* Allow ellipsis to work in flex child */
            min-width: 0;
        }

        .info-row-value {
            font-size: 15px;
            color: #111827;
            line-height: 1.5;
            /* Truncate long addresses/URLs gracefully */
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            word-wrap: break-word;
            word-break: break-word;
        }

        .info-row-icon {
            font-size: 20px;
            color: #9ca3af;
            margin-left: 12px;
            margin-top: 2px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
        }

        /* Business Hours status */
        .hours-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
        }

        .hours-status-badge {
            font-size: 15px;
            font-weight: 500;
        }

        .hours-status-badge.open {
            color: #10b981;
        }

        .hours-status-badge.closed {
            color: #ef4444;
        }

        /* Happy Hour status colors */
        .hours-status-badge.hh-status-on-now {
            color: #10b981;  /* Green - HH is happening now */
        }

        .hours-status-badge.hh-status-neutral {
            color: #111827;  /* Dark gray - starts later or ended */
        }

        .hours-status-badge.hh-status-none-today {
            color: #9ca3af;  /* Light gray - no HH today */
        }

        .hours-status-text {
            font-size: 15px;
            font-weight: 500;
            color: #6b7280;
        }

        /* Hours expansion toggle - inline with status */
        .hours-toggle {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 13px;
            color: #3b82f6;
            font-weight: 500;
            cursor: pointer;
            user-select: none;
            margin-left: 8px;
        }

        /* Happy Hour header row: Today: <status> | Show full schedule */
        .hh-header-row {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 4px;
        }

        .hh-status-left {
            flex: 1;
            display: flex;
            align-items: baseline;
            gap: 6px;
            flex-wrap: wrap;
        }

        .hh-today-label {
            font-size: 15px;
            font-weight: 500;
            color: #111827;
        }

        .hh-schedule-link {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 13px;
            color: #3b82f6;
            font-weight: 500;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .hh-schedule-link:hover {
            color: #2563eb;
        }

        /* Happy Hour section headings (Times + Specials) */
        .hh-section-heading {
            font-size: 14px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 12px;
        }

        .hours-toggle:hover {
            color: #2563eb;
        }

        .hours-disclosure {
            font-size: 10px;
            transition: transform 0.2s;
        }

        .hours-disclosure.expanded {
            transform: rotate(180deg);
        }

        .hours-weekly {
            margin-top: 12px;
            display: none;
            flex-direction: column;
            gap: 8px;
        }

        .hours-weekly.visible {
            display: flex;
        }

        .hours-day-row {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }

        .hours-day-name {
            font-weight: 600;
            color: #374151;
        }

        .hours-day-time {
            color: #6b7280;
        }

        .info-row.clickable {
            cursor: pointer;
            padding: 8px;
            margin: -8px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .info-row.clickable:hover {
            background: #f9fafb;
        }

        .info-row strong {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
        }

        .info-row div {
            font-size: 14px;
            color: #6b7280;
            line-height: 1.5;
        }

        .venue-map-embed {
            height: 200px;
            width: 100%;
            border-radius: 8px;
            border: 3px solid #10b981;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .venue-map-embed:hover {
            transform: scale(1.01);
        }

        .map-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .map-modal-header {
            background: white;
            padding: 16px 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .map-modal-header h2 {
            font-size: 18px;
            font-weight: 700;
            color: #111827;
            margin: 0;
        }

        .map-modal-close {
            background: none;
            border: none;
            color: #3b82f6;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .map-modal-close:hover {
            background: #f3f4f6;
        }

        .map-modal-content {
            flex: 1;
            position: relative;
        }

        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }

        .logo-icon {
            width: 120px;
            height: 120px;
        }

        .tagline {
            font-size: 18px;
            opacity: 0.9;
            margin-top: 8px;
            font-weight: 500;
        }

        .back-btn {
            position: absolute;
            left: 20px;
            top: 50px;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .search-bar {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 10px;
            padding: 12px 12px 12px 40px;
            margin-top: 15px;
            width: 100%;
            font-size: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
            height: 48px;
        }

        .search-wrapper {
            position: relative;
            flex: 1;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            font-size: 18px;
            pointer-events: none;
        }

        .search-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .view-toggle-btn {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 10px;
            padding: 12px;
            font-size: 14px;
            font-weight: 500;
            color: #3b82f6;
            cursor: pointer;
            white-space: nowrap;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: background 0.2s;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 6px;
            height: 48px;
            box-sizing: border-box;
        }

        .view-toggle-btn:hover {
            background: #f9fafb;
        }

        .view-toggle-btn svg {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        .filter-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #6b7280;
            padding: 12px 20px 6px 20px;
        }

        .filter-section {
            flex-shrink: 0;
            max-height: 200px;
            opacity: 1;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
        }

        .filter-section.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .filters {
            display: flex;
            gap: 10px;
            padding: 15px 20px;
            overflow-x: auto;
            flex-shrink: 0;
            max-height: 100px;
            opacity: 1;
            transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease;
        }

        .filters.collapsed {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
            overflow: hidden;
        }

        .filter-chip {
            background: white;
            border: 2px solid #d1d5db;
            border-radius: 20px;
            padding: 8px 16px;
            white-space: nowrap;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .filter-chip:hover {
            border-color: #9ca3af;
            background: #f9fafb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .filter-chip:active {
            transform: scale(0.97);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .filter-chip.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }

        .filter-chip.active:hover {
            background: #2563eb;
            border-color: #2563eb;
        }


        .content {
            flex: 1;
            padding: 20px;
            padding-bottom: 140px;
            overflow-y: auto;
        }

        .listing-item {
            background: white;
            border-radius: 8px;
            padding: 14px;
            margin-bottom: 1px;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            display: flex;
            gap: 12px;
            transition: background 0.15s ease;
        }

        .listing-item:hover {
            background: #fafbfc;
        }

        .listing-image {
            width: 72px;
            height: 72px;
            border-radius: 8px;
            flex-shrink: 0;
        }

        .listing-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .listing-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2px;
        }

        .listing-name {
            font-weight: 700;
            font-size: 17px;
            color: #111827;
            line-height: 1.2;
            /* Clamp to 2 lines max, allow flex to work properly */
            flex: 1;
            min-width: 0;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            word-wrap: break-word;
            word-break: break-word;
        }

        .bookmark-icon {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-left: 8px;
        }

        .bookmark-icon svg {
            width: 18px;
            height: 18px;
            fill: none;
            stroke: #d1d5db;
            stroke-width: 2;
            transition: fill 0.2s, stroke 0.2s;
        }

        .bookmark-icon.saved svg {
            fill: #f97316;
            stroke: #f97316;
        }

        .status-badge {
            display: inline-block;
            padding: 3px 7px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            margin-right: 6px;
        }

        .status-open {
            background: #dcfce7;
            color: #166534;
        }

        .status-soon {
            background: #fef3c7;
            color: #92400e;
        }

        .listing-time-range {
            color: #6b7280;
            font-weight: 500;
            font-size: 14px;
            line-height: 1.3;
        }

        .listing-offer {
            color: #111827;
            font-weight: 700;
            font-size: 16px;
            line-height: 1.3;
            /* Clamp to 2 lines for long offer text */
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            word-wrap: break-word;
        }

        .listing-details {
            color: #6b7280;
            font-size: 14px;
            line-height: 1.4;
        }

        .distance-prominent {
            color: #3b82f6;
            font-size: 12px;
            font-weight: 500;
        }

        .category-tag {
            color: #6b7280;
            font-size: 11px;
            margin-left: 6px;
            /* Truncate very long category names */
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .listing-meta {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            color: #9ca3af;
            /* Allow wrapping for long metadata */
            flex-wrap: wrap;
            min-width: 0;
        }

        .time-remaining {
            color: #dc2626;
            font-size: 13px;
            font-weight: 600;
        }

        /* Single HH status line for Search */
        .hh-status-line {
            font-size: 14px;
            font-weight: 500;
            line-height: 1.3;
            margin-top: 2px;
            /* Keep as single scannable line, truncate if too long */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .hh-status-line.hh-green {
            color: #10b981;
        }

        .hh-status-line.hh-neutral {
            color: #111827;
        }

        .hh-status-line.hh-muted {
            color: #9ca3af;
        }

        .section-header {
            color: #374151;
            font-size: 15px;
            margin-bottom: 10px;
            margin-top: 16px;
            font-weight: 700;
            letter-spacing: -0.01em;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 375px;
            display: flex;
            background: white;
            border-top: 1px solid #e5e7eb;
            padding: 12px 0;
            z-index: 101;
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 8px;
            cursor: pointer;
            font-size: 12px;
            color: #6b7280;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .nav-item.active {
            color: #3b82f6;
        }

        .nav-icon {
            display: block;
            margin-bottom: 4px;
        }

        /* Nav bookmark icon: outline by default, filled when active */
        .nav-bookmark-icon {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-bookmark-icon svg {
            width: 20px;
            height: 20px;
        }

        .nav-bookmark-icon svg path {
            fill: none;
            stroke: #6b7280;
            stroke-width: 2;
        }

        .nav-item.active .nav-bookmark-icon svg path {
            fill: #3b82f6;
            stroke: #3b82f6;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            text-align: center;
        }

        .btn-primary {
            background: #ea580c;
            color: white;
            flex: 2;
        }

        .btn-secondary, .btn-share {
            background: #3b82f6;
            color: white;
            flex: 1;
        }

        .event-item {
            background: white;
            border-radius: 8px;
            padding: 14px;
            margin-bottom: 1px;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .event-item:hover {
            background: #fafbfc;
        }

        .event-title {
            font-weight: 700;
            font-size: 17px;
            color: #111827;
            margin-bottom: 4px;
            line-height: 1.2;
        }

        .event-venue {
            color: #3b82f6;
            font-size: 14px;
            margin-bottom: 2px;
            font-weight: 500;
        }

        .event-time {
            color: #6b7280;
            font-size: 13px;
        }

        .hero {
            height: 200px;
            background: linear-gradient(135deg, #8b5cf6, #3b82f6);
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
        }

        .hero-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .hero-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 4px;
        }

        .hero-subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .venue-info {
            margin-bottom: 20px;
        }

        .venue-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .venue-address {
            color: #6b7280;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .info-box {
            background: #dbeafe;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #1e40af;
            line-height: 1.5;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-textarea {
            height: 100px;
            resize: vertical;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            font-size: 16px;
            font-weight: 400;
        }

        .success-screen {
            text-align: center;
            padding-top: 100px;
        }

        .success-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .success-screen h2 {
            margin-bottom: 16px;
        }

        .success-screen p {
            color: #6b7280;
            margin-bottom: 40px;
            line-height: 1.5;
            padding: 0 20px;
        }

        .page-header {
            background: white;
            padding: 16px 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-header.sticky {
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .page-title {
            font-size: 20px;
            font-weight: bold;
            color: #111827;
            margin: 0;
        }

        .search-toggle-btn {
            background: none;
            border: none;
            color: #3b82f6;
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .search-toggle-btn:hover {
            background: #f3f4f6;
        }

        .search-container {
            display: none;
            background: white;
            padding: 0 20px 16px;
            position: sticky;
            top: 57px;
            z-index: 49;
            border-bottom: 1px solid #e5e7eb;
        }

        .search-container.active {
            display: block;
        }

        /* Calendar button for events */
        .calendar-btn {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s, border-color 0.2s;
            flex-shrink: 0;
            margin-left: 8px;
        }

        .calendar-btn:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }

        .calendar-btn svg {
            color: #6b7280;
        }

        /* Custom Calendar Styles */
        .custom-calendar-container {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 16px 20px;
        }

        .calendar-card {
            background: white;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .calendar-month-label {
            font-size: 15px;
            font-weight: 600;
            color: #111827;
        }

        .calendar-nav-btn {
            background: none;
            border: none;
            padding: 6px;
            cursor: pointer;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            transition: background 0.2s;
        }

        .calendar-nav-btn:hover {
            background: #f3f4f6;
        }

        .calendar-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 8px;
        }

        .calendar-weekday {
            text-align: center;
            font-size: 11px;
            font-weight: 600;
            color: #6b7280;
            padding: 8px 0;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 16px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 500;
            color: #111827;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            border: 1px solid transparent;
        }

        .calendar-day:hover:not(.disabled):not(.empty) {
            background: #f3f4f6;
            border-color: #e5e7eb;
        }

        .calendar-day.empty {
            cursor: default;
            visibility: hidden;
        }

        .calendar-day.disabled {
            color: #d1d5db;
            cursor: not-allowed;
            background: #fafafa;
        }

        .calendar-day.today {
            font-weight: 700;
            color: #0284c7;
        }

        /* Range selection states */
        .calendar-day.range-start {
            background: #0284c7;
            color: white;
            font-weight: 600;
            border-color: #0284c7;
        }

        .calendar-day.range-end {
            background: #0284c7;
            color: white;
            font-weight: 600;
            border-color: #0284c7;
        }

        .calendar-day.in-range {
            background: #bae6fd;
            color: #0c4a6e;
            border-color: #7dd3fc;
        }

        .calendar-range-display {
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .calendar-actions {
            display: flex;
            gap: 8px;
        }

        /* From/To Date Fields */
        .calendar-from-to-fields {
            display: flex;
            gap: 12px;
            align-items: stretch;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e5e7eb;
        }

        .date-field {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .date-field:hover {
            border-color: #cbd5e1;
            background: #f9fafb;
        }

        .date-field.active {
            border-color: #0284c7;
            background: #f0f9ff;
        }

        .date-field-label {
            font-size: 11px;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .date-field-value {
            font-size: 14px;
            font-weight: 500;
            color: #111827;
        }

        .date-field-value.placeholder {
            color: #9ca3af;
            font-style: italic;
        }

        /* Calendar Helper Text */
        .calendar-helper-text {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 12px;
            padding: 8px 12px;
            background: #f9fafb;
            border-radius: 6px;
            text-align: center;
        }

        .date-picker-container {
            background: white;
            border-bottom: 1px solid #e5e7eb;
        }

        /* Empty States */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 60px 40px;
            color: #6b7280;
            position: relative;
        }

        .empty-state-close {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 32px;
            height: 32px;
            border: none;
            background: #f3f4f6;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            font-size: 18px;
            transition: background 0.2s, color 0.2s;
        }

        .empty-state-close:hover {
            background: #e5e7eb;
            color: #374151;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .empty-state-body {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 20px;
        }

        .empty-state-action {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .empty-state-action:hover {
            background: #2563eb;
        }

        .empty-state-action.orange {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .empty-state-action.orange:hover {
            background: linear-gradient(135deg, #d97706, #b45309);
        }

        .empty-state-secondary {
            background: transparent;
            color: #3b82f6;
            border: 1px solid #3b82f6;
            margin-top: 8px;
        }

        .empty-state-secondary:hover {
            background: #eff6ff;
        }

        /* Hero Image Fallback */
        .venue-hero-image {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .venue-hero-image::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .venue-hero-image.fallback::before {
            opacity: 1;
        }

        .venue-hero-image.fallback::after {
            content: 'Photo not available';
            position: absolute;
            color: #9ca3af;
            font-size: 14px;
            font-weight: 500;
            z-index: 1;
        }
    </style>
</head>
<body>
    <div class="phone-frame">
        <!-- Splash Screen (logo only, for subsequent launches) -->
        <div class="screen splash-screen" id="splash-screen">
            <img src="logo.png" alt="Happy Hour Compass" class="splash-logo">
        </div>

        <!-- Home Screen (first-launch only) -->
        <div class="screen home-screen" id="home-screen">
            <img src="logo.png" alt="Happy Hour Compass" class="splash-logo">
            <p class="home-tagline">Your guide to local happy hours</p>
            <button class="home-cta" id="home-cta-btn">Explore happy hours</button>
        </div>

        <!-- Search Screen -->
        <div class="screen" id="search-screen">
            <div style="padding: 20px 20px 0;">
                <div class="search-controls">
                    <div class="search-wrapper">
                        <span class="search-icon">üîç</span>
                        <input type="text" class="search-bar" placeholder="Search venues..." id="search-input" style="margin-top: 0;">
                    </div>
                    <button class="view-toggle-btn" id="view-toggle-btn" onclick="toggleViewInline()">
                        <span id="toggle-icon-svg"></span>
                        <span id="toggle-label">Map</span>
                    </button>
                </div>
            </div>

            <div class="filter-section" id="search-filter-section">
                <div class="filter-label">Filter results</div>
                <div class="filters" id="search-filters">
                    <button class="filter-chip">Happening Now</button>
                    <!-- TODO: "Near Me" is a placeholder chip for Alpha. Will be wired to location-based filtering in a later phase. -->
                    <button class="filter-chip">Near Me</button>
                    <button class="filter-chip">Open Now</button>
                    <button class="filter-chip">Sports Bars</button>
                    <button class="filter-chip">Fine Dining</button>
                    <button class="filter-chip">Under $10</button>
                </div>
            </div>

            <div class="content" id="list-content">
                <!-- Search Empty State (hidden by default, shown when no results) -->
                <div class="empty-state" id="search-empty-state" style="display: none;">
                    <button class="empty-state-close" onclick="dismissSearchEmptyState()" aria-label="Close">‚úï</button>
                    <div class="empty-state-icon">üîç</div>
                    <div class="empty-state-title">No matches</div>
                    <div class="empty-state-body">Try clearing filters or searching a different area.</div>
                    <div class="empty-state-body" style="margin-top: 24px; margin-bottom: 12px;">Can't find your favorite spot?</div>
                    <button class="empty-state-action orange" onclick="showScreen('create-ask-screen')">Suggest a place</button>
                </div>
                <!-- Venue cards will be rendered dynamically from venuesData -->
            </div>

            <div class="content" id="map-content" style="display: none;">
                <div id="map" style="height: 300px; width: 100%; border-radius: 8px; margin-bottom: 20px; border: 3px solid #10b981;"></div>
                <!-- Venue count and cards will be rendered dynamically from venuesData -->
            </div>
        </div>

        <!-- Saved Screen -->
        <div class="screen" id="favorites-screen">
            <div class="page-header sticky">
                <h1 class="page-title">Saved</h1>
                <button class="search-toggle-btn" id="favorites-search-toggle" onclick="toggleFavoritesSearch()">
                    üîç
                </button>
            </div>

            <div class="search-container" id="favorites-search-container">
                <div class="search-wrapper">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="search-bar" placeholder="Search saved..." id="favorites-search-input" style="margin-top: 0;">
                </div>
            </div>

            <div class="content" id="favorites-content">
                <!-- Saved Empty State (shown when no saved items exist) -->
                <div class="empty-state" id="favorites-empty-state" style="display: flex;">
                    <div class="empty-state-icon">üîñ</div>
                    <div class="empty-state-title">No saved places yet</div>
                    <div class="empty-state-body">Tap the bookmark on a venue to save it here.</div>
                    <button class="empty-state-action" onclick="showScreen('search-screen')">Browse venues</button>
                </div>
                <!-- Saved items are dynamically rendered here by renderSavedPage() -->
            </div>
        </div>

        <!-- Events Screen -->
        <div class="screen" id="events-screen">
            <div class="page-header sticky">
                <h1 class="page-title">Events</h1>
                <button class="search-toggle-btn" id="events-search-toggle" onclick="toggleEventsSearch()">
                    üîç
                </button>
            </div>

            <div class="search-container" id="events-search-container">
                <div class="search-wrapper">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="search-bar" placeholder="Search events..." id="events-search-input" style="margin-top: 0;">
                </div>
            </div>

            <div class="filter-section" id="events-filter-section">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 20px 6px 20px;">
                    <div class="filter-label" style="padding: 0;">Filter events</div>
                    <button class="calendar-btn" id="events-calendar-btn" onclick="toggleEventsCalendar()" title="Select date">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                    </button>
                </div>
                <div class="filters" id="events-filters">
                    <button class="filter-chip" id="events-chip-today" onclick="filterEventsBy('today')">Happening Today</button>
                    <button class="filter-chip" id="events-chip-weekend" onclick="filterEventsBy('weekend')">This Weekend</button>
                </div>
            </div>

            <!-- Custom calendar range picker (hidden by default) -->
            <div class="custom-calendar-container" id="events-calendar-picker" style="display: none;">
                <div class="calendar-card">
                    <!-- From/To date fields -->
                    <div class="calendar-from-to-fields">
                        <div class="date-field" id="date-field-from" onclick="setActiveField('from')">
                            <div class="date-field-label">From</div>
                            <div class="date-field-value" id="date-field-from-value">Select start</div>
                        </div>
                        <div style="color: #9ca3af; padding-top: 20px;">‚Üí</div>
                        <div class="date-field" id="date-field-to" onclick="setActiveField('to')">
                            <div class="date-field-label">To</div>
                            <div class="date-field-value" id="date-field-to-value">Select end</div>
                        </div>
                    </div>

                    <!-- Helper text guidance -->
                    <div class="calendar-helper-text" id="calendar-helper-text">Select a start date</div>

                    <!-- Calendar header with month navigation -->
                    <div class="calendar-header">
                        <button class="calendar-nav-btn" id="calendar-prev-month" onclick="navigateCalendarMonth(-1)">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="15 18 9 12 15 6"></polyline>
                            </svg>
                        </button>
                        <div class="calendar-month-label" id="calendar-month-label">January 2026</div>
                        <button class="calendar-nav-btn" id="calendar-next-month" onclick="navigateCalendarMonth(1)">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </button>
                    </div>

                    <!-- Weekday headers -->
                    <div class="calendar-weekdays">
                        <div class="calendar-weekday">Su</div>
                        <div class="calendar-weekday">Mo</div>
                        <div class="calendar-weekday">Tu</div>
                        <div class="calendar-weekday">We</div>
                        <div class="calendar-weekday">Th</div>
                        <div class="calendar-weekday">Fr</div>
                        <div class="calendar-weekday">Sa</div>
                    </div>

                    <!-- Calendar grid (dynamically populated) -->
                    <div class="calendar-grid" id="calendar-grid"></div>

                    <!-- Action buttons -->
                    <div class="calendar-actions">
                        <button class="btn btn-primary" style="flex: 1;" onclick="applyCalendarRange()">Apply</button>
                        <button class="btn" style="flex: 1; background: white; border: 1px solid #d1d5db;" onclick="clearCalendarRange()">Clear</button>
                    </div>
                </div>
            </div>

            <div class="content" id="events-content">
                <!-- Events Empty State (hidden when events exist) -->
                <div class="empty-state" id="events-empty-state" style="display: none;">
                    <div class="empty-state-icon">üéâ</div>
                    <div class="empty-state-title">No events found</div>
                    <div class="empty-state-body">Try adjusting your filters or check back later for new events.</div>
                </div>
                <!-- Event cards will be rendered dynamically from eventsData -->
            </div>
        </div>

        <!-- Venue Detail Screen -->
        <div class="screen" id="detail-screen">
            <div class="detail-page-header" id="venue-detail-header">
                <button class="detail-back-btn" onclick="goBack()">‚Üê</button>
                <h1 class="detail-page-title" id="venue-detail-title">Venue Details</h1>
                <div class="header-actions">
                    <button class="header-icon-btn header-bookmark-btn" id="venue-save-btn" onclick="toggleVenueSave(event)">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                        </svg>
                    </button>
                    <button class="header-icon-btn" onclick="shareVenue()">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="venue-detail-scroll" id="venue-detail-scroll">
                <!-- Collapsible Header Content -->
                <div class="venue-header-collapsible" id="venue-header-collapsible">
                    <div class="venue-hero-image" id="venue-hero-image"></div>
                    <div class="venue-name-section">
                        <h2 class="venue-name-large" id="venue-name-large">Venue Name</h2>
                        <div class="venue-meta-row" id="venue-meta-row">
                            <span class="status-badge status-open" id="venue-status">Open Now</span>
                            <span class="distance-prominent" id="venue-distance">0.3 km</span>
                            <span class="category-tag" id="venue-category">‚Ä¢ Category</span>
                        </div>
                    </div>
                    <div class="venue-action-buttons" id="venue-action-buttons">
                        <button class="venue-action-btn" id="venue-btn-reservation">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                            <span>Reserve</span>
                        </button>
                        <button class="venue-action-btn" id="venue-btn-call" onclick="callVenue()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                            </svg>
                            <span>Call</span>
                        </button>
                        <button class="venue-action-btn" id="venue-btn-website" onclick="openVenueWebsite()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="2" y1="12" x2="22" y2="12"></line>
                                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                            </svg>
                            <span>Website</span>
                        </button>
                    </div>
                </div>

                <!-- Sticky Jump Chips Nav -->
                <!-- TODO: May become horizontal carousel to support additional sections post-Alpha -->
                <div class="venue-section-nav venue-tabs" id="venue-tabs">
                    <div class="venue-nav-label">Jump to</div>
                    <div class="venue-chips-row">
                        <button id="tab-happyhour" class="section-nav-item venue-tab" onclick="scrollToVenueSection('happyhour')">Happy Hour</button>
                        <button id="tab-info" class="section-nav-item venue-tab" onclick="scrollToVenueSection('info')">Info</button>
                    </div>
                </div>

                <!-- Content Sections -->
                <div class="venue-sections">
                    <!-- Happy Hour Section -->
                    <div class="venue-section" id="section-happyhour">
                        <div class="scroll-anchor" id="anchor-happyhour" aria-hidden="true"></div>
                        <h3 class="section-title">Happy Hour</h3>
                        <div class="info-box" id="venue-happy-hour-box">
                            <strong>Happy Hour Times</strong><br>
                            Monday - Friday: 3:00 PM - 6:00 PM<br><br>
                            <strong>Current Specials</strong><br>
                            ‚Ä¢ $6 appetizers<br>
                            ‚Ä¢ $5 house wine & beer
                        </div>
                    </div>

                    <!-- Info Section -->
                    <div class="venue-section" id="section-info">
                        <div class="scroll-anchor" id="anchor-info" aria-hidden="true"></div>
                        <h3 class="section-title">Info</h3>

                        <!-- Info rows container - populated by renderVenueInfo() -->
                        <div class="venue-info-details" id="venue-info-container">
                            <!-- Conditionally rendered rows will appear here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Expanded Map Modal -->
            <div class="map-modal" id="map-modal" style="display: none;">
                <div class="map-modal-header">
                    <h2 id="map-modal-title">Venue Location</h2>
                    <button class="map-modal-close" onclick="closeExpandedMap()">‚úï</button>
                </div>
                <div id="detail-map-expanded" class="map-modal-content"></div>
            </div>
        </div>

        <!-- Event Detail Screen -->
        <div class="screen" id="event-detail-screen">
            <div class="detail-page-header" id="event-detail-header">
                <button class="detail-back-btn" onclick="goBack()">‚Üê</button>
                <h1 class="detail-page-title" id="event-detail-title">Event Details</h1>
                <div class="header-actions">
                    <button class="header-icon-btn header-bookmark-btn" id="event-save-btn" onclick="toggleEventSave(event)">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                        </svg>
                    </button>
                    <button class="header-icon-btn" onclick="shareEvent()">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="venue-detail-scroll" id="event-detail-scroll">
                <!-- Collapsible Header Content -->
                <div class="venue-header-collapsible" id="event-header-collapsible">
                    <div class="venue-hero-image" id="event-hero-image"></div>
                    <div class="venue-name-section">
                        <h2 class="venue-name-large" id="event-name-large">Event Name</h2>
                        <div class="event-venue-text" id="event-venue-text">
                            <span id="event-venue-name">Venue Name</span>
                        </div>
                        <div class="venue-meta-row" id="event-meta-row">
                            <span id="event-date-time">Date ‚Ä¢ Time</span>
                        </div>
                    </div>
                    <div class="venue-action-buttons" id="event-action-buttons">
                        <button class="venue-action-btn" id="event-btn-tickets">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path>
                            </svg>
                            <span>Tickets</span>
                        </button>
                        <button class="venue-action-btn" id="event-btn-call" onclick="callEventVenue()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                            </svg>
                            <span>Call</span>
                        </button>
                        <button class="venue-action-btn" id="event-btn-website" onclick="openEventWebsite()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="2" y1="12" x2="22" y2="12"></line>
                                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                            </svg>
                            <span>Website</span>
                        </button>
                    </div>
                </div>

                <!-- Sticky Jump Chips Nav -->
                <div class="venue-section-nav venue-tabs" id="event-tabs">
                    <div class="venue-nav-label">Jump to</div>
                    <div class="venue-chips-row">
                        <button id="tab-event" class="section-nav-item venue-tab" onclick="scrollToEventSection('event')">Event</button>
                        <button id="tab-venue" class="section-nav-item venue-tab" onclick="scrollToEventSection('venue')">Venue</button>
                    </div>
                </div>

                <!-- Content Sections -->
                <div class="venue-sections">
                    <!-- Event Section -->
                    <div class="venue-section" id="section-event">
                        <div class="scroll-anchor" id="anchor-event" aria-hidden="true"></div>
                        <h3 class="section-title">Event</h3>
                        <div class="info-box" id="event-details-box">
                            <strong>Overview</strong><br>
                            Event details will appear here
                        </div>
                    </div>

                    <!-- Venue Section -->
                    <div class="venue-section" id="section-venue">
                        <div class="scroll-anchor" id="anchor-venue" aria-hidden="true"></div>
                        <h3 class="section-title">Venue</h3>

                        <!-- Info rows container - populated by renderEventVenueInfo() -->
                        <div class="venue-info-details" id="event-venue-info-container">
                            <!-- Conditionally rendered rows will appear here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Ask Screen -->
        <div class="screen" id="create-ask-screen">
            <div class="detail-page-header">
                <button class="detail-back-btn" onclick="closeAskPage()" aria-label="Close">‚úï</button>
                <h1 class="detail-page-title">Add a Venue</h1>
            </div>
            <div class="content">
                <div class="info-box">
                    <strong>Help us grow!</strong><br>
                    Don't see your favorite venue listed? Tell us about it and we'll reach out to them to get their deals added to the app.
                </div>
                <div class="form-group">
                    <label class="form-label">Venue Name *</label>
                    <input type="text" class="form-input" placeholder="e.g., Jimmy's Sports Bar">
                </div>
                <div class="form-group">
                    <label class="form-label">Location (optional)</label>
                    <input type="text" class="form-input" placeholder="e.g., Downtown Kelowna, Westbank">
                </div>
                <div class="form-group">
                    <label class="form-label">Additional Details (optional)</label>
                    <textarea class="form-textarea" placeholder="Tell us what makes this place special or what deals they usually have..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="showScreen('success-screen')">Submit Request</button>
            </div>
        </div>

        <!-- Success Screen -->
        <div class="screen" id="success-screen">
            <div class="header">
                <h1>Request Submitted!</h1>
            </div>
            <div class="content success-screen">
                <div class="success-icon">‚úÖ</div>
                <h2>Thanks for your suggestion!</h2>
                <p>We've received your venue request and will reach out to them soon. You'll be notified when they're added to the app.</p>
                <button class="btn btn-primary" onclick="showScreen('search-screen')">Back to Search</button>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-item active" onclick="showScreen('search-screen')">
                <span class="nav-icon">üîç</span>
                Search
            </div>
            <div class="nav-item" onclick="showScreen('favorites-screen')">
                <span class="nav-icon nav-bookmark-icon">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                    </svg>
                </span>
                Saved
            </div>
            <div class="nav-item" onclick="showScreen('events-screen')">
                <span class="nav-icon">üéâ</span>
                Events
            </div>
        </div>
    </div>

    <script>
        let currentScreen = 'search-screen';
        let previousScreen = 'search-screen';

        // ===== CENTRAL SAVED STATE =====
        // Single source of truth for all saved venues and events
        // Stores venue/event IDs (not names) for proper data model integration
        // Persisted to localStorage for session continuity
        const savedVenues = new Set(JSON.parse(localStorage.getItem('savedVenues') || '[]'));
        const savedEvents = new Set(JSON.parse(localStorage.getItem('savedEvents') || '[]'));

        // Persist saved state to localStorage
        function persistSavedState() {
            localStorage.setItem('savedVenues', JSON.stringify([...savedVenues]));
            localStorage.setItem('savedEvents', JSON.stringify([...savedEvents]));
        }

        // Migrate legacy name-based saved items to ID-based (called after data model is loaded)
        function migrateSavedStateToIds() {
            let migrated = false;

            // Migrate venues: if a saved item is a name (not an ID), convert it
            const venuesToMigrate = [];
            savedVenues.forEach(item => {
                // Check if item is a name (exists in venuesByName but not venuesById)
                if (!venuesById[item] && venuesByName[item]) {
                    const venue = venuesByName[item];
                    venuesToMigrate.push({ oldName: item, newId: venue.id });
                }
            });
            venuesToMigrate.forEach(({ oldName, newId }) => {
                savedVenues.delete(oldName);
                savedVenues.add(newId);
                migrated = true;
            });

            // Migrate events: if a saved item is a name (not an ID), convert it
            const eventsToMigrate = [];
            savedEvents.forEach(item => {
                // Check if item is a name (exists in eventsByName but not eventsById)
                if (!eventsById[item] && eventsByName[item]) {
                    const event = eventsByName[item];
                    eventsToMigrate.push({ oldName: item, newId: event.id });
                }
            });
            eventsToMigrate.forEach(({ oldName, newId }) => {
                savedEvents.delete(oldName);
                savedEvents.add(newId);
                migrated = true;
            });

            // Persist if any migrations occurred
            if (migrated) {
                persistSavedState();
            }
        }

        // Check if a venue is saved (accepts ID or name)
        function isVenueSaved(idOrName) {
            // First try direct ID lookup
            if (savedVenues.has(idOrName)) return true;
            // Fall back to name lookup - find the venue and check its ID
            const venue = getVenue(idOrName);
            return venue ? savedVenues.has(venue.id) : false;
        }

        // Check if an event is saved (accepts ID or name)
        function isEventSaved(idOrName) {
            // First try direct ID lookup
            if (savedEvents.has(idOrName)) return true;
            // Fall back to name lookup - find the event and check its ID
            const event = getEvent(idOrName);
            return event ? savedEvents.has(event.id) : false;
        }

        // Toggle saved state for a venue (accepts ID or name, stores ID)
        function toggleVenueSavedState(idOrName) {
            const venue = getVenue(idOrName);
            if (!venue) return;

            const id = venue.id;
            if (savedVenues.has(id)) {
                savedVenues.delete(id);
            } else {
                savedVenues.add(id);
            }
            persistSavedState();
            syncAllBookmarkIcons();
            renderSavedPage();
        }

        // Toggle saved state for an event (accepts ID or name, stores ID)
        function toggleEventSavedState(idOrName) {
            const event = getEvent(idOrName);
            if (!event) return;

            const id = event.id;
            if (savedEvents.has(id)) {
                savedEvents.delete(id);
            } else {
                savedEvents.add(id);
            }
            persistSavedState();
            syncAllBookmarkIcons();
            renderSavedPage();
        }

        // Sync all bookmark icons across the app to match central state
        function syncAllBookmarkIcons() {
            // Sync venue bookmarks on search cards (list view)
            document.querySelectorAll('#list-content .listing-item').forEach(item => {
                const venueId = item.getAttribute('data-venue-id');
                const venueName = item.querySelector('.listing-name')?.textContent;
                const identifier = venueId || venueName;
                const bookmarkBtn = item.querySelector('.bookmark-icon');
                if (identifier && bookmarkBtn) {
                    if (isVenueSaved(identifier)) {
                        bookmarkBtn.classList.add('saved');
                    } else {
                        bookmarkBtn.classList.remove('saved');
                    }
                }
            });

            // Sync venue bookmarks on search cards (map view)
            document.querySelectorAll('#map-content .listing-item').forEach(item => {
                const venueId = item.getAttribute('data-venue-id');
                const venueName = item.querySelector('.listing-name')?.textContent;
                const identifier = venueId || venueName;
                const bookmarkBtn = item.querySelector('.bookmark-icon');
                if (identifier && bookmarkBtn) {
                    if (isVenueSaved(identifier)) {
                        bookmarkBtn.classList.add('saved');
                    } else {
                        bookmarkBtn.classList.remove('saved');
                    }
                }
            });

            // Sync event bookmarks on events listing page
            document.querySelectorAll('#events-content .event-item').forEach(item => {
                const eventId = item.getAttribute('data-event-id');
                const eventName = item.querySelector('.event-title')?.textContent;
                const identifier = eventId || eventName;
                const bookmarkBtn = item.querySelector('.bookmark-icon');
                if (identifier && bookmarkBtn) {
                    if (isEventSaved(identifier)) {
                        bookmarkBtn.classList.add('saved');
                    } else {
                        bookmarkBtn.classList.remove('saved');
                    }
                }
            });

            // Sync bookmarks on Saved page
            document.querySelectorAll('#favorites-content .listing-item').forEach(item => {
                const venueId = item.getAttribute('data-venue-id');
                const venueName = item.querySelector('.listing-name')?.textContent;
                const identifier = venueId || venueName;
                const bookmarkBtn = item.querySelector('.bookmark-icon');
                if (identifier && bookmarkBtn) {
                    if (isVenueSaved(identifier)) {
                        bookmarkBtn.classList.add('saved');
                    } else {
                        bookmarkBtn.classList.remove('saved');
                    }
                }
            });

            document.querySelectorAll('#favorites-content .event-item').forEach(item => {
                const eventId = item.getAttribute('data-event-id');
                const eventName = item.querySelector('.event-title')?.textContent;
                const identifier = eventId || eventName;
                const bookmarkBtn = item.querySelector('.bookmark-icon');
                if (identifier && bookmarkBtn) {
                    if (isEventSaved(identifier)) {
                        bookmarkBtn.classList.add('saved');
                    } else {
                        bookmarkBtn.classList.remove('saved');
                    }
                }
            });

            // Sync venue detail page bookmark (if visible)
            const venueSaveBtn = document.getElementById('venue-save-btn');
            if (venueSaveBtn && currentVenueName) {
                if (isVenueSaved(currentVenueName)) {
                    venueSaveBtn.classList.add('saved');
                } else {
                    venueSaveBtn.classList.remove('saved');
                }
            }

            // Sync event detail page bookmark (if visible)
            const eventSaveBtn = document.getElementById('event-save-btn');
            if (eventSaveBtn && currentEventData) {
                if (isEventSaved(currentEventData.name)) {
                    eventSaveBtn.classList.add('saved');
                } else {
                    eventSaveBtn.classList.remove('saved');
                }
            }
        }

        // ===== CENTRALIZED DATA MODEL =====
        //
        // HOW TO ADD/EDIT VENUES AND EVENTS FOR BETA:
        // 1. Each venue/event has a unique 'id' field - use lowercase-hyphenated format (e.g., 'the-keg-kelowna')
        // 2. The 'id' is used for Saved state and cross-referencing (events link to venues via 'venueId')
        // 3. Add new entries to the venuesData or eventsData arrays below
        // 4. Beta data will be maintained via CSV ‚Üí AI ‚Üí JS object conversion
        //
        // REQUIRED VENUE FIELDS:
        //   - id: string (unique identifier, used by Saved and filters)
        //   - name: string (display name)
        //   - type: string (category - powers 'sports-bars', 'fine-dining' filters)
        //   - latitude: number (decimal degrees, e.g. 49.8854 - powers distance calc and 'near-me' filter)
        //   - longitude: number (decimal degrees, e.g. -119.4937 - powers distance calc and 'near-me' filter)
        //   - address: string
        //   - phone: string
        //   - happyHourWeekly: object (powers 'happening-now' filter)
        //   - hoursWeekly: object (powers 'open-now' filter)
        //   - specialsFood: array of strings (powers 'under-10' filter)
        //   - specialsDrinks: array of strings (powers 'under-10' filter)
        //
        // OPTIONAL VENUE FIELDS:
        //   - icon, image, menuUrl, websiteUrl, paymentMethods
        //
        // REQUIRED EVENT FIELDS:
        //   - id: string (unique identifier, used by Saved)
        //   - name: string (display name)
        //   - venueId: string (links to venue.id)
        //   - schedule: string (e.g., 'Every Sunday' - powers 'today'/'weekend' filters)
        //   - time: string (e.g., '5:00 PM - 11:00 PM')
        //
        // OPTIONAL EVENT FIELDS:
        //   - icon, type, description, offers, image

        const venuesData = [
            {
                id: 'the-keg-kelowna',
                name: 'The Keg Kelowna',
                icon: 'üçΩÔ∏è',
                type: 'Upscale Restaurant',
                latitude: 49.8854,
                longitude: -119.4937,
                address: '532 Bernard Ave, Kelowna, BC',
                phone: '(250) 763-1442',
                image: 'images/fine-dining-1.jpg',
                happyHourWeekly: {
                    'Sunday': [],
                    'Monday': [{start: '15:00', end: '18:00'}],
                    'Tuesday': [{start: '15:00', end: '18:00'}],
                    'Wednesday': [{start: '15:00', end: '18:00'}],
                    'Thursday': [{start: '15:00', end: '18:00'}],
                    'Friday': [{start: '15:00', end: '18:00'}, {start: '21:00', end: 'close'}],
                    'Saturday': [{start: '14:00', end: '17:00'}]
                },
                hoursWeekly: {
                    'Sunday': '10:00 AM - 11:00 PM',
                    'Monday': 'CLOSED',
                    'Tuesday': '11:00 AM - 11:00 PM',
                    'Wednesday': '11:00 AM - 11:00 PM',
                    'Thursday': '11:00 AM - 11:00 PM',
                    'Friday': '11:00 AM - 12:00 AM',
                    'Saturday': '10:00 AM - 12:00 AM'
                },
                specialsFood: ['$6 appetizers', '$8 gourmet burgers'],
                specialsDrinks: ['$5 house wine & beer', '$8 signature cocktails'],
                menuUrl: 'https://kegsteakhouse.com/menu',
                websiteUrl: 'https://kegsteakhouse.com',
                paymentMethods: 'Visa, Mastercard, Amex, Debit, Cash'
            },
            {
                id: 'white-spot',
                name: 'White Spot',
                icon: 'üçî',
                type: 'Family Restaurant',
                latitude: 49.8901,
                longitude: -119.4851,
                address: '1405 Harvey Ave, Kelowna, BC',
                phone: '(250) 860-7768',
                image: 'images/casual-dining-1.jpg',
                happyHourWeekly: {
                    'Sunday': [{start: '13:00', end: '16:00'}],
                    'Monday': [{start: '14:00', end: '17:00'}],
                    'Tuesday': [{start: '14:00', end: '17:00'}],
                    'Wednesday': [{start: '14:00', end: '17:00'}],
                    'Thursday': [{start: '14:00', end: '17:00'}],
                    'Friday': [{start: '14:00', end: '17:00'}],
                    'Saturday': [{start: '13:00', end: '16:00'}]
                },
                hoursWeekly: {
                    'Sunday': '7:00 AM - 11:00 PM',
                    'Monday': '7:00 AM - 11:00 PM',
                    'Tuesday': '7:00 AM - 11:00 PM',
                    'Wednesday': '7:00 AM - 11:00 PM',
                    'Thursday': '7:00 AM - 11:00 PM',
                    'Friday': '7:00 AM - 12:00 AM',
                    'Saturday': '7:00 AM - 12:00 AM'
                },
                specialsFood: ['$4 chicken wings', '$5 nachos'],
                specialsDrinks: ['$3.50 draft beer', '$5 cocktails'],
                menuUrl: 'https://whitespot.ca/menu',
                websiteUrl: 'https://whitespot.ca',
                paymentMethods: 'Visa, Mastercard, Amex, Debit, Cash'
            },
            {
                id: 'anfield-restaurant',
                name: 'Anfield Restaurant',
                icon: '‚öΩ',
                type: 'Sports Bar',
                latitude: 49.8833,
                longitude: -119.4789,
                address: '1620 Dickson Ave, Kelowna, BC',
                phone: '(250) 717-5687',
                image: 'images/sports-bar-1.jpg',
                happyHourWeekly: {
                    'Sunday': [{start: '16:00', end: '19:00'}],
                    'Monday': [{start: '16:00', end: '19:00'}],
                    'Tuesday': [{start: '16:00', end: '19:00'}],
                    'Wednesday': [],
                    'Thursday': [{start: '16:00', end: '19:00'}],
                    'Friday': [{start: '16:00', end: '19:00'}],
                    'Saturday': [{start: '16:00', end: '19:00'}]
                },
                hoursWeekly: {
                    'Sunday': '10:00 AM - 12:00 AM',
                    'Monday': '11:00 AM - 1:00 AM',
                    'Tuesday': '11:00 AM - 1:00 AM',
                    'Wednesday': '11:00 AM - 1:00 AM',
                    'Thursday': '11:00 AM - 1:00 AM',
                    'Friday': '11:00 AM - 2:00 AM',
                    'Saturday': '10:00 AM - 2:00 AM'
                },
                specialsFood: ['$8 gourmet burgers', '$6 appetizer platters', '$0.50 wings (min 10)'],
                specialsDrinks: ['$4 cocktails', '$5 beer buckets'],
                menuUrl: 'https://anfieldkelowna.com/menu',
                websiteUrl: 'https://anfieldkelowna.com',
                paymentMethods: 'Visa, Mastercard, Amex, Debit, Cash'
            },
            {
                id: 'moxies-kelowna',
                name: 'Moxies Kelowna',
                icon: 'üç∏',
                type: 'Casual Dining',
                latitude: 49.8812,
                longitude: -119.4702,
                address: '551 Bernard Ave, Kelowna, BC',
                phone: '(250) 763-7771',
                image: 'images/casual-dining-2.jpg',
                happyHourWeekly: {
                    'Sunday': [{start: '14:00', end: '17:00'}],
                    'Monday': [{start: '15:00', end: '18:00'}],
                    'Tuesday': [{start: '15:00', end: '18:00'}],
                    'Wednesday': [{start: '15:00', end: '18:00'}],
                    'Thursday': [{start: '15:00', end: '18:00'}],
                    'Friday': [{start: '15:00', end: '18:00'}],
                    'Saturday': [{start: '14:00', end: '17:00'}]
                },
                hoursWeekly: {
                    'Sunday': '10:00 AM - 12:00 AM',
                    'Monday': '11:00 AM - 12:00 AM',
                    'Tuesday': '11:00 AM - 12:00 AM',
                    'Wednesday': '11:00 AM - 12:00 AM',
                    'Thursday': '11:00 AM - 12:00 AM',
                    'Friday': '11:00 AM - 1:00 AM',
                    'Saturday': '10:00 AM - 1:00 AM'
                },
                specialsFood: ['$5 appetizers', '$7 flatbreads'],
                specialsDrinks: ['$6 signature cocktails', '$4 wine by the glass', '$5 draft beer'],
                menuUrl: 'https://moxies.com/menu',
                websiteUrl: 'https://moxies.com',
                paymentMethods: 'Visa, Mastercard, Amex, Debit, Cash'
            }
        ];

        const eventsData = [
            {
                id: 'nfl-game-night',
                name: 'NFL Game Night',
                icon: 'üèà',
                type: 'Sports Bar Event',
                venueId: 'anfield-restaurant',
                schedule: 'Every Sunday',
                dayOfWeek: 'Sunday',
                time: '5:00 PM - 11:00 PM',
                description: 'Join us every Sunday for NFL game nights! Watch your favorite teams on our big screens while enjoying special pricing on wings, nachos, and game-day drinks. Perfect for groups!',
                offers: '‚Ä¢ $0.50 wings (minimum 10)<br>‚Ä¢ $5 beer buckets<br>‚Ä¢ $12 nachos for two<br>‚Ä¢ $15 pitcher specials',
                image: 'images/event-nfl.jpg'
            },
            {
                id: 'wine-tasting',
                name: 'Wine Tasting',
                icon: 'üç∑',
                type: 'Fine Dining Event',
                venueId: 'the-keg-kelowna',
                schedule: 'Every Thursday',
                dayOfWeek: 'Thursday',
                time: '6:00 PM - 9:00 PM',
                description: 'Experience our curated wine tasting featuring local Okanagan wines paired with signature appetizers. Learn about wine varieties from our sommelier.',
                offers: '‚Ä¢ 5 wine tastings for $25<br>‚Ä¢ Paired appetizers included<br>‚Ä¢ 20% off featured wines<br>‚Ä¢ Sommelier-guided experience',
                image: 'images/event-wine.jpg'
            },
            {
                id: 'trivia-night',
                name: 'Trivia Night',
                icon: 'üß†',
                type: 'Family Event',
                venueId: 'white-spot',
                schedule: 'Every Wednesday',
                dayOfWeek: 'Wednesday',
                time: '7:00 PM - 10:00 PM',
                description: 'Test your knowledge at our weekly trivia night! Great for families and groups. Prizes for top teams and special happy hour pricing on food and drinks.',
                offers: '‚Ä¢ $3 appetizers during trivia<br>‚Ä¢ $2.50 beer<br>‚Ä¢ Prize for winning team<br>‚Ä¢ Family-friendly atmosphere',
                image: 'images/event-trivia.jpg'
            }
        ];

        // ===== DATA MODEL LOOKUP HELPERS =====
        // These provide fast lookups by ID and backwards-compatible lookups by name

        // Build lookup maps for O(1) access
        const venuesById = {};
        const venuesByName = {};  // For backwards compatibility during transition
        venuesData.forEach(venue => {
            venuesById[venue.id] = venue;
            venuesByName[venue.name] = venue;
        });

        const eventsById = {};
        const eventsByName = {};  // For backwards compatibility during transition
        eventsData.forEach(event => {
            eventsById[event.id] = event;
            eventsByName[event.name] = event;
        });

        // Helper to get venue by ID or name (for backwards compatibility)
        function getVenue(idOrName) {
            return venuesById[idOrName] || venuesByName[idOrName] || null;
        }

        // Helper to get event by ID or name (for backwards compatibility)
        function getEvent(idOrName) {
            return eventsById[idOrName] || eventsByName[idOrName] || null;
        }

        // Helper to get venue for an event
        function getVenueForEvent(event) {
            if (!event) return null;
            return venuesById[event.venueId] || null;
        }

        // Legacy aliases for backwards compatibility with existing code
        const venues = venuesByName;
        const events = eventsByName;

        // ===== USER LOCATION & DISTANCE CALCULATION =====
        // Kelowna downtown fallback coordinates (used when geolocation is unavailable)
        const KELOWNA_FALLBACK = { latitude: 49.8880, longitude: -119.4960 };
        const NEAR_ME_RADIUS_KM = 2; // "Near Me" filter radius in km

        // Current user location (set on app load via geolocation or fallback)
        let userLocation = null;

        // Haversine formula: calculates distance in km between two lat/lng points
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // Get computed distance from user to a venue (in km, rounded to 1 decimal)
        function getVenueDistance(venue) {
            if (!userLocation || !venue.latitude || !venue.longitude) return null;
            return Math.round(haversineDistance(
                userLocation.latitude, userLocation.longitude,
                venue.latitude, venue.longitude
            ) * 10) / 10;
        }

        // Format distance for display
        function formatDistance(venue) {
            const dist = getVenueDistance(venue);
            if (dist === null) return '';
            return dist + ' km';
        }

        // Capture user location via browser Geolocation API
        function captureUserLocation() {
            return new Promise(function(resolve) {
                if (!navigator.geolocation) {
                    userLocation = KELOWNA_FALLBACK;
                    resolve(userLocation);
                    return;
                }
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        userLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        resolve(userLocation);
                    },
                    function() {
                        // Permission denied or error ‚Äî fall back to Kelowna
                        userLocation = KELOWNA_FALLBACK;
                        resolve(userLocation);
                    },
                    { timeout: 5000, maximumAge: 300000 }
                );
            });
        }

        // ===== VENUE/EVENT RENDER FUNCTIONS =====
        // These functions render venue and event cards from the data model

        // Generate HTML for a single venue card (list view with image)
        function renderVenueCardListView(venue) {
            if (!venue) return '';
            const savedClass = isVenueSaved(venue.id) ? 'saved' : '';
            return `
                <div class="listing-item" data-venue-id="${venue.id}" onclick="showVenueDetail('${venue.name}')">
                    <div class="listing-image">
                        <img src="${getVenueImage(venue)}" alt="${venue.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                    </div>
                    <div class="listing-content">
                        <div class="listing-header">
                            <div class="listing-name">${venue.name}</div>
                            <button class="bookmark-icon ${savedClass}" onclick="event.stopPropagation(); handleBookmarkClick(this)">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                                </svg>
                            </button>
                        </div>
                        <div class="listing-offer">${getVenueShortSpecials(venue)}</div>
                        <div class="listing-meta">
                            <span class="status-badge status-open">Open Now</span>
                            <span class="distance-prominent">${formatDistance(venue)}</span>
                            <span class="category-tag">‚Ä¢ ${venue.type}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // Generate HTML for a single venue card (map view - compact)
        function renderVenueCardMapView(venue) {
            if (!venue) return '';
            const savedClass = isVenueSaved(venue.id) ? 'saved' : '';
            return `
                <div class="listing-item" data-venue-id="${venue.id}" onclick="showVenueDetail('${venue.name}')">
                    <div class="listing-header">
                        <div class="listing-name">${venue.name}</div>
                        <button class="bookmark-icon ${savedClass}" onclick="event.stopPropagation(); handleBookmarkClick(this)">
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="listing-time-range">Happy Hour Times</div>
                    <div class="distance-prominent">${formatDistance(venue)}</div>
                </div>
            `;
        }

        // Generate HTML for a single event card
        function renderEventCard(event) {
            if (!event) return '';
            const savedClass = isEventSaved(event.id) ? 'saved' : '';
            const venue = getVenueForEvent(event);
            const venueName = venue ? venue.name : 'Unknown Venue';
            return `
                <div class="event-item" data-event-id="${event.id}" onclick="showEventDetail('${event.name}')">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <div class="event-title">${event.name}</div>
                            <div class="event-venue">${venueName}</div>
                            <div class="event-time">${event.schedule} ${event.time}</div>
                        </div>
                        <button class="bookmark-icon ${savedClass}" onclick="event.stopPropagation(); handleBookmarkClick(this)">
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
        }

        // Render all venues to the list view container
        function renderVenueListView(filteredVenues = null) {
            const container = document.getElementById('list-content');
            if (!container) return;

            // Keep the empty state element
            const emptyState = container.querySelector('#search-empty-state');

            // Clear existing venue cards
            container.querySelectorAll('.listing-item, .section-header').forEach(el => el.remove());

            // Get venues to render (all venues if no filter)
            const venuesToRender = filteredVenues || venuesData;

            // Show empty state if no venues
            if (venuesToRender.length === 0) {
                if (emptyState) emptyState.style.display = 'flex';
                return;
            }

            if (emptyState) emptyState.style.display = 'none';

            // Split into "Popular" and "All Venues" sections
            // For now, mark first 2 as popular (can be enhanced with actual popularity data)
            const popularVenues = venuesToRender.slice(0, 2);
            const allVenues = venuesToRender.slice(2);

            // Add Popular section
            if (popularVenues.length > 0) {
                container.insertAdjacentHTML('beforeend', '<h3 class="section-header">üî• Popular Right Now</h3>');
                popularVenues.forEach(venue => {
                    container.insertAdjacentHTML('beforeend', renderVenueCardListView(venue));
                });
            }

            // Add All Venues section
            if (allVenues.length > 0) {
                container.insertAdjacentHTML('beforeend', '<h3 class="section-header">All Venues</h3>');
                allVenues.forEach(venue => {
                    container.insertAdjacentHTML('beforeend', renderVenueCardListView(venue));
                });
            }

            // Update HH status on all cards
            updateAllListingHHStatus();
        }

        // Render all venues to the map view container
        function renderVenueMapView(filteredVenues = null) {
            const container = document.getElementById('map-content');
            if (!container) return;

            // Keep the map element
            const mapElement = container.querySelector('#map');

            // Clear existing venue cards but keep map
            container.querySelectorAll('.listing-item').forEach(el => el.remove());

            // Remove old count text
            const oldCount = container.querySelector('[style*="font-size: 14px"]');
            if (oldCount) oldCount.remove();

            // Get venues to render (all venues if no filter)
            const venuesToRender = filteredVenues || venuesData;

            // Add count text
            const countHtml = `<div style="font-size: 14px; color: #6b7280; margin-bottom: 20px;">${venuesToRender.length} venues found nearby</div>`;
            if (mapElement) {
                mapElement.insertAdjacentHTML('afterend', countHtml);
            }

            // Render venue cards
            venuesToRender.forEach(venue => {
                container.insertAdjacentHTML('beforeend', renderVenueCardMapView(venue));
            });
        }

        // Render all events to the events container
        function renderEventsList(filteredEvents = null) {
            const container = document.getElementById('events-content');
            if (!container) return;

            // Keep the empty state element if exists
            const emptyState = container.querySelector('#events-empty-state');

            // Clear existing event cards
            container.querySelectorAll('.event-item').forEach(el => el.remove());

            // Get events to render (all events if no filter)
            const eventsToRender = filteredEvents || eventsData;

            // Show empty state if no events
            if (eventsToRender.length === 0) {
                if (emptyState) emptyState.style.display = 'flex';
                return;
            }

            if (emptyState) emptyState.style.display = 'none';

            // Render event cards
            eventsToRender.forEach(event => {
                container.insertAdjacentHTML('beforeend', renderEventCard(event));
            });
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });

            previousScreen = currentScreen;
            currentScreen = screenId;

            document.getElementById(screenId).classList.add('active');

            updateNavHighlighting(screenId);

            // Sync bookmark icons across all views when switching screens
            syncAllBookmarkIcons();

            // Render saved page when showing favorites screen
            if (screenId === 'favorites-screen') {
                renderSavedPage();
            }
        }

        function initializeVenueDetailMap() {
            const container = document.getElementById('detail-map');
            if (!container) {
                return;
            }

            console.log('Initializing venue detail map');
            
            // Ensure container has height
            container.style.height = '200px';
            
            // Create static map visualization for venue
            container.innerHTML = `
                <div style="height: 100%; background: linear-gradient(135deg, #e0f2fe, #b3e5fc); border-radius: 8px; position: relative; overflow: hidden;">
                    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; opacity: 0.1; background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.1) 10px, rgba(255,255,255,0.1) 20px);"></div>
                    
                    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;">
                        <div style="position: absolute; top: 25%; left: 0; right: 0; height: 1px; background: rgba(255,255,255,0.3);"></div>
                        <div style="position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: rgba(255,255,255,0.3);"></div>
                        <div style="position: absolute; top: 75%; left: 0; right: 0; height: 1px; background: rgba(255,255,255,0.3);"></div>
                        <div style="position: absolute; top: 0; bottom: 0; left: 25%; width: 1px; background: rgba(255,255,255,0.3);"></div>
                        <div style="position: absolute; top: 0; bottom: 0; left: 50%; width: 1px; background: rgba(255,255,255,0.3);"></div>
                        <div style="position: absolute; top: 0; bottom: 0; left: 75%; width: 1px; background: rgba(255,255,255,0.3);"></div>
                    </div>
                    
                    <div style="position: absolute; top: 45%; left: 48%; transform: translate(-50%, -50%); background: #ef4444; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 16px; border: 3px solid white; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);">üìç</div>
                    
                    <div style="position: absolute; bottom: 15px; left: 15px; right: 15px; background: rgba(255,255,255,0.95); padding: 12px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer;">
                        <div style="font-weight: bold; color: #0277bd; margin-bottom: 4px;">Venue Location</div>
                        <div style="font-size: 12px; color: #666; margin-bottom: 6px;">Click to open in maps</div>
                        <div style="font-size: 11px; color: #0277bd; font-weight: 500;">üó∫Ô∏è Open in Maps App</div>
                    </div>
                </div>
            `;
        }

        function initializeEventDetailMap() {
            const container = document.getElementById('event-detail-map');
            if (!container) {
                return;
            }

            console.log('Initializing event detail map');
            
            // Ensure container has height
            container.style.height = '200px';
            
            // Create static map visualization for event
            container.innerHTML = `
                <div style="height: 100%; background: linear-gradient(135deg, #e0f2fe, #b3e5fc); border-radius: 8px; position: relative; overflow: hidden;">
                    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; opacity: 0.1; background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.1) 10px, rgba(255,255,255,0.1) 20px);"></div>
                    
                    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;">
                        <div style="position: absolute; top: 25%; left: 0; right: 0; height: 1px; background: rgba(255,255,255,0.3);"></div>
                        <div style="position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: rgba(255,255,255,0.3);"></div>
                        <div style="position: absolute; top: 75%; left: 0; right: 0; height: 1px; background: rgba(255,255,255,0.3);"></div>
                        <div style="position: absolute; top: 0; bottom: 0; left: 25%; width: 1px; background: rgba(255,255,255,0.3);"></div>
                        <div style="position: absolute; top: 0; bottom: 0; left: 50%; width: 1px; background: rgba(255,255,255,0.3);"></div>
                        <div style="position: absolute; top: 0; bottom: 0; left: 75%; width: 1px; background: rgba(255,255,255,0.3);"></div>
                    </div>
                    
                    <div style="position: absolute; top: 55%; left: 52%; transform: translate(-50%, -50%); background: #ef4444; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 16px; border: 3px solid white; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);">üìç</div>
                    
                    <div style="position: absolute; bottom: 15px; left: 15px; right: 15px; background: rgba(255,255,255,0.95); padding: 12px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer;">
                        <div style="font-weight: bold; color: #0277bd; margin-bottom: 4px;">Event Location</div>
                        <div style="font-size: 12px; color: #666; margin-bottom: 6px;">Click to open in maps</div>
                        <div style="font-size: 11px; color: #0277bd; font-weight: 500;">üó∫Ô∏è Open in Maps App</div>
                    </div>
                </div>
            `;
        }

        // Store current venue for actions
        let currentVenue = null;
        let currentVenueName = null;

        // DEBUG FLAG - Set to true to enable detailed logging
        const DEBUG_HOURS = false;

        // TODO: Business Hours edge-case handling (skipping CLOSED days) is intentional.
        // Calculate Business Hours open/closed status with next-opening logic
        function calculateBusinessHoursStatus(hoursWeekly) {
            if (!hoursWeekly) return { status: 'Unknown', text: 'Hours unavailable' };

            const now = new Date();
            const currentDay = now.getDay(); // 0 = Sunday, 1 = Monday, etc.
            const currentTime = now.getHours() * 60 + now.getMinutes(); // Minutes since midnight

            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const todayName = dayNames[currentDay];
            const todayHours = hoursWeekly[todayName];

            if (DEBUG_HOURS) {
                console.log('=== Business Hours Debug ===');
                console.log('Current time:', now.toString());
                console.log('Current time ISO:', now.toISOString());
                console.log('Current day index (Date.getDay()):', currentDay);
                console.log('Current day name:', todayName);
                console.log('Current time in minutes:', currentTime, `(${Math.floor(currentTime/60)}:${String(currentTime%60).padStart(2,'0')})`);
                console.log('Today\'s hours string:', todayHours);
                console.log('Full hoursWeekly object:', hoursWeekly);
            }

            // Helper: Parse "11:00 AM - 11:00 PM" to {open: minutes, close: minutes}
            function parseHours(hoursStr) {
                if (!hoursStr || hoursStr === 'CLOSED' || hoursStr === 'Closed') {
                    if (DEBUG_HOURS) console.log('parseHours: CLOSED or null');
                    return null;
                }

                const match = hoursStr.match(/(\d{1,2}):(\d{2})\s*(AM|PM)\s*[-‚Äì]\s*(\d{1,2}):(\d{2})\s*(AM|PM)/i);
                if (!match) {
                    if (DEBUG_HOURS) console.log('parseHours: Failed to match regex for:', hoursStr);
                    return null;
                }

                let openHour = parseInt(match[1]);
                const openMin = parseInt(match[2]);
                const openPeriod = match[3].toUpperCase();
                let closeHour = parseInt(match[4]);
                const closeMin = parseInt(match[5]);
                const closePeriod = match[6].toUpperCase();

                if (DEBUG_HOURS) {
                    console.log('parseHours: Raw match:', { openHour, openMin, openPeriod, closeHour, closeMin, closePeriod });
                }

                // Convert to 24-hour
                if (openPeriod === 'PM' && openHour !== 12) openHour += 12;
                if (openPeriod === 'AM' && openHour === 12) openHour = 0;
                if (closePeriod === 'PM' && closeHour !== 12) closeHour += 12;
                if (closePeriod === 'AM' && closeHour === 12) closeHour = 0;

                let openMinutes = openHour * 60 + openMin;
                let closeMinutes = closeHour * 60 + closeMin;

                // Fix midnight closing time: "12:00 AM" as close means end-of-day (1440 minutes)
                if (closeMinutes === 0 && openMinutes > 0) {
                    closeMinutes = 1440; // End of day
                }

                // Handle overnight hours: if close <= open, it crosses midnight into next day
                if (closeMinutes <= openMinutes && closeMinutes !== 1440) {
                    closeMinutes += 1440; // Add 24 hours to represent next day
                }

                const result = {
                    open: openMinutes,
                    close: closeMinutes,
                    openStr: `${match[1]}:${match[2]} ${match[3]}`,
                    closeStr: `${match[4]}:${match[5]} ${match[6]}`,
                    isOvernight: closeMinutes > 1440
                };

                if (DEBUG_HOURS) {
                    console.log('parseHours: Converted to 24h:', {
                        openHour24: openHour,
                        closeHour24: closeHour,
                        openMinutes: result.open,
                        closeMinutes: result.close,
                        isOvernight: result.isOvernight
                    });
                }

                return result;
            }

            // Check today's hours
            const today = parseHours(todayHours);

            if (DEBUG_HOURS) {
                console.log('Parsed today\'s hours:', today);
            }

            if (!today) {
                if (DEBUG_HOURS) console.log('BRANCH: Today is CLOSED - finding next opening');
                // Today is CLOSED - find next opening
                for (let i = 1; i <= 7; i++) {
                    const nextDayIndex = (currentDay + i) % 7;
                    const nextDayName = dayNames[nextDayIndex];
                    const nextHours = parseHours(hoursWeekly[nextDayName]);

                    if (nextHours) {
                        const result = {
                            status: 'Closed',
                            text: `opens ${i === 1 ? 'tomorrow at' : 'on ' + nextDayName + ' at'} ${nextHours.openStr}`,
                            isOpen: false
                        };
                        if (DEBUG_HOURS) console.log('RESULT:', result);
                        return result;
                    }
                }
                const result = { status: 'Closed', text: 'reopening TBD', isOpen: false };
                if (DEBUG_HOURS) console.log('RESULT:', result);
                return result;
            }

            // Check if we're still open from yesterday's overnight hours
            const yesterdayIndex = (currentDay - 1 + 7) % 7;
            const yesterdayName = dayNames[yesterdayIndex];
            const yesterday = parseHours(hoursWeekly[yesterdayName]);

            if (yesterday && yesterday.isOvernight) {
                // Yesterday had overnight hours - check if we're in the spill window
                const yesterdaySpillEnd = yesterday.close - 1440; // Convert back to today's minutes
                if (currentTime < yesterdaySpillEnd) {
                    // We're still open from yesterday!
                    if (DEBUG_HOURS) console.log('BRANCH: Still open from yesterday\'s overnight hours');
                    const result = {
                        status: 'Open now',
                        text: `closes at ${yesterday.closeStr}`,
                        isOpen: true
                    };
                    if (DEBUG_HOURS) console.log('RESULT:', result);
                    return result;
                }
            }

            // Today has hours - check current time
            if (DEBUG_HOURS) {
                console.log('Today has hours - comparing times:');
                console.log('  currentTime:', currentTime);
                console.log('  today.open:', today.open);
                console.log('  today.close:', today.close);
                console.log('  today.isOvernight:', today.isOvernight);
            }

            // Check today's window
            if (today.isOvernight) {
                // Overnight hours - check today's portion (open until midnight)
                if (currentTime >= today.open) {
                    // We're in today's open portion (will continue past midnight)
                    if (DEBUG_HOURS) console.log('BRANCH: Currently OPEN (overnight hours, today portion)');
                    const result = {
                        status: 'Open now',
                        text: `closes at ${today.closeStr}`,
                        isOpen: true
                    };
                    if (DEBUG_HOURS) console.log('RESULT:', result);
                    return result;
                } else {
                    // Before opening today
                    if (DEBUG_HOURS) console.log('BRANCH: Before opening today');
                    const result = {
                        status: 'Closed',
                        text: `opens at ${today.openStr}`,
                        isOpen: false
                    };
                    if (DEBUG_HOURS) console.log('RESULT:', result);
                    return result;
                }
            } else {
                // Normal same-day hours
                if (currentTime < today.open) {
                    // Before opening today
                    if (DEBUG_HOURS) console.log('BRANCH: Before opening today');
                    const result = {
                        status: 'Closed',
                        text: `opens at ${today.openStr}`,
                        isOpen: false
                    };
                    if (DEBUG_HOURS) console.log('RESULT:', result);
                    return result;
                } else if (currentTime >= today.open && currentTime <= today.close) {
                    // Currently open (same-day hours)
                    if (DEBUG_HOURS) console.log('BRANCH: Currently OPEN (same-day hours)');
                    const result = {
                        status: 'Open now',
                        text: `closes at ${today.closeStr}`,
                        isOpen: true
                    };
                    if (DEBUG_HOURS) console.log('RESULT:', result);
                    return result;
                } else {
                    // After closing today - find next opening
                    if (DEBUG_HOURS) console.log('BRANCH: After closing today - finding next opening');
                    for (let i = 1; i <= 7; i++) {
                        const nextDayIndex = (currentDay + i) % 7;
                        const nextDayName = dayNames[nextDayIndex];
                        const nextHours = parseHours(hoursWeekly[nextDayName]);

                        if (nextHours) {
                            const result = {
                                status: 'Closed',
                                text: `opens ${i === 1 ? 'tomorrow at' : 'on ' + nextDayName + ' at'} ${nextHours.openStr}`,
                                isOpen: false
                            };
                            if (DEBUG_HOURS) console.log('RESULT:', result);
                            return result;
                        }
                    }
                    const result = { status: 'Closed', text: 'reopening TBD', isOpen: false };
                    if (DEBUG_HOURS) console.log('RESULT:', result);
                    return result;
                }
            }
        }

        // Generate HH status HTML for Search card (always returns HTML string, never empty)
        function generateSearchHHStatusHTML(venueName) {
            const venue = venues[venueName];

            // If venue not found, fallback to approved HH language
            if (!venue) {
                return `<div class="hh-status-line hh-muted">No happy hour today</div>`;
            }

            // If no HH data, use approved HH language
            if (!venue.happyHourWeekly) {
                return `<div class="hh-status-line hh-muted">No happy hour today</div>`;
            }

            const hhStatus = calculateSearchHHStatus(venue.happyHourWeekly);

            // If calculation fails, use approved HH language
            if (!hhStatus) {
                return `<div class="hh-status-line hh-muted">No happy hour today</div>`;
            }

            const colorClass = hhStatus.color === 'green' ? 'hh-green' :
                              hhStatus.color === 'neutral' ? 'hh-neutral' : 'hh-muted';

            return `<div class="hh-status-line ${colorClass}">${hhStatus.text}</div>`;
        }

        // TODO: Search uses a simplified single-line HH summary for scannability, with full truth/details on the Venue Detail page
        // Calculate simplified Happy Hour status for Search listings (single line)
        function calculateSearchHHStatus(happyHourWeekly) {
            if (!happyHourWeekly) return null;

            const now = new Date();
            const currentDay = now.getDay();
            const currentTime = now.getHours() * 60 + now.getMinutes();

            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const todayName = dayNames[currentDay];
            const todayWindows = happyHourWeekly[todayName] || [];

            // Helper: Convert 24-hour time to minutes
            function timeToMinutes(timeStr) {
                if (timeStr === 'close') return 1440;
                const [hours, minutes] = timeStr.split(':').map(Number);
                return hours * 60 + minutes;
            }

            // Helper: Format time for display
            function formatTime(timeStr) {
                if (timeStr === 'close') return 'close';
                const [hours, minutes] = timeStr.split(':').map(Number);
                const period = hours >= 12 ? 'PM' : 'AM';
                const displayHour = hours === 0 ? 12 : hours > 12 ? hours - 12 : hours;
                return `${displayHour}${minutes > 0 ? ':' + minutes.toString().padStart(2, '0') : ''} ${period}`;
            }

            // State 1: HH happening now
            for (const window of todayWindows) {
                const startMin = timeToMinutes(window.start);
                const endMin = window.end === 'close' ? 1440 : timeToMinutes(window.end);
                if (currentTime >= startMin && currentTime < endMin) {
                    return {
                        text: `Happy hour on now ¬∑ until ${formatTime(window.end)}`,
                        color: 'green'
                    };
                }
            }

            // State 2: HH starts later today
            const upcomingWindowsToday = todayWindows.filter(w => timeToMinutes(w.start) > currentTime);
            if (upcomingWindowsToday.length > 0) {
                const nextWindow = upcomingWindowsToday[0];
                return {
                    text: `Happy hour starts at ${formatTime(nextWindow.start)}`,
                    color: 'neutral'
                };
            }

            // State 3: HH ended today or no HH today - use approved language
            return {
                text: 'No happy hour today',
                color: 'muted'
            };
        }

        // TODO: HH uses "on now / starts / ended" language intentionally to avoid confusion with business hours "Open/Closed"
        // Calculate Happy Hour status supporting 0-2 windows per day
        function calculateHappyHourStatus(happyHourWeekly) {
            if (!happyHourWeekly) return { status: 'unavailable', text: 'Schedule unavailable', windows: [] };

            const now = new Date();
            const currentDay = now.getDay(); // 0 = Sunday
            const currentTime = now.getHours() * 60 + now.getMinutes(); // Minutes since midnight

            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const todayName = dayNames[currentDay];
            const todayWindows = happyHourWeekly[todayName] || [];

            // Helper: Convert 24-hour time string to minutes since midnight
            function timeToMinutes(timeStr) {
                if (timeStr === 'close') return 1440; // End of day for sorting purposes
                const [hours, minutes] = timeStr.split(':').map(Number);
                return hours * 60 + minutes;
            }

            // Helper: Format time for display
            function formatTime(timeStr) {
                if (timeStr === 'close') return 'close';
                const [hours, minutes] = timeStr.split(':').map(Number);
                const period = hours >= 12 ? 'PM' : 'AM';
                const displayHour = hours === 0 ? 12 : hours > 12 ? hours - 12 : hours;
                return `${displayHour}${minutes > 0 ? ':' + minutes.toString().padStart(2, '0') : ''} ${period}`;
            }

            // State 1: Check if HH is happening now (within ANY window today)
            for (const window of todayWindows) {
                const startMin = timeToMinutes(window.start);
                const endMin = window.end === 'close' ? 1440 : timeToMinutes(window.end);

                if (currentTime >= startMin && currentTime < endMin) {
                    return {
                        status: 'on-now',
                        text: `On now ¬∑ until ${formatTime(window.end)}`,
                        isActive: true,
                        windows: todayWindows
                    };
                }
            }

            // State 2: Check if there's a later window today
            const upcomingWindowsToday = todayWindows.filter(w => timeToMinutes(w.start) > currentTime);
            if (upcomingWindowsToday.length > 0) {
                const nextWindow = upcomingWindowsToday[0];
                return {
                    status: 'starts-later',
                    text: `Starts at ${formatTime(nextWindow.start)}`,
                    isActive: false,
                    windows: todayWindows
                };
            }

            // State 3: All windows today have ended (and there was at least 1 window)
            if (todayWindows.length > 0) {
                const lastWindow = todayWindows[todayWindows.length - 1];
                return {
                    status: 'ended',
                    text: `Ended at ${formatTime(lastWindow.end)}`,
                    isActive: false,
                    windows: todayWindows
                };
            }

            // State 4: No happy hour today - find next day with HH
            for (let i = 1; i <= 7; i++) {
                const nextDayIndex = (currentDay + i) % 7;
                const nextDayName = dayNames[nextDayIndex];
                const nextDayWindows = happyHourWeekly[nextDayName] || [];

                if (nextDayWindows.length > 0) {
                    const dayLabel = i === 1 ? 'Tomorrow' : nextDayName;
                    return {
                        status: 'none-today',
                        text: `No happy hour today ¬∑ Next happy hour: ${dayLabel}`,
                        isActive: false,
                        windows: []
                    };
                }
            }

            return {
                status: 'none',
                text: 'No happy hour this week',
                isActive: false,
                windows: []
            };
        }

        // Render Happy Hour section with status line, expandable schedule, and grouped specials
        function renderHappyHourSection(venue) {
            if (!venue.happyHourWeekly) {
                return `<div class="info-box">Happy hour information not available.</div>`;
            }

            const hhStatus = calculateHappyHourStatus(venue.happyHourWeekly);

            // Helper: Format window for display
            function formatWindow(window) {
                const startTime = window.start;
                const endTime = window.end;
                const [startHours, startMinutes] = startTime.split(':').map(Number);
                const endDisplay = endTime === 'close' ? 'close' : (() => {
                    const [endHours, endMinutes] = endTime.split(':').map(Number);
                    const endPeriod = endHours >= 12 ? 'PM' : 'AM';
                    const endDisplayHour = endHours === 0 ? 12 : endHours > 12 ? endHours - 12 : endHours;
                    return `${endDisplayHour}${endMinutes > 0 ? ':' + endMinutes.toString().padStart(2, '0') : ''} ${endPeriod}`;
                })();

                const startPeriod = startHours >= 12 ? 'PM' : 'AM';
                const startDisplayHour = startHours === 0 ? 12 : startHours > 12 ? startHours - 12 : startHours;
                const startDisplay = `${startDisplayHour}${startMinutes > 0 ? ':' + startMinutes.toString().padStart(2, '0') : ''} ${startPeriod}`;

                return `${startDisplay}‚Äì${endDisplay}`;
            }

            // Build schedule HTML
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const scheduleHtml = dayNames.map(day => {
                const windows = venue.happyHourWeekly[day] || [];
                let timeDisplay = '';

                if (windows.length === 0) {
                    timeDisplay = 'No happy hour';
                } else if (windows.length === 1) {
                    timeDisplay = formatWindow(windows[0]);
                } else {
                    // Multiple windows - show as comma-separated list
                    timeDisplay = windows.map(w => formatWindow(w)).join(', ');
                }

                return `
                    <div class="hours-day-row">
                        <span class="hours-day-name">${day}</span>
                        <span class="hours-day-time">${timeDisplay}</span>
                    </div>
                `;
            }).join('');

            // Determine status class
            const statusClass = hhStatus.isActive ? 'on-now' :
                               hhStatus.status === 'none-today' ? 'none-today' :
                               'neutral';

            // Build specials HTML
            let specialsHtml = '';
            if (venue.specialsFood || venue.specialsDrinks) {
                specialsHtml = '<div class="hh-section-heading" style="margin-top: 20px;">Happy Hour Specials</div>';

                if (venue.specialsFood && venue.specialsFood.length > 0) {
                    specialsHtml += '<div style="margin-top: 12px; font-weight: 600; font-size: 13px; color: #374151;">Food</div>';
                    specialsHtml += venue.specialsFood.map(item => `<div style="margin-top: 4px;">‚Ä¢ ${item}</div>`).join('');
                }

                if (venue.specialsDrinks && venue.specialsDrinks.length > 0) {
                    specialsHtml += '<div style="margin-top: 12px; font-weight: 600; font-size: 13px; color: #374151;">Drinks</div>';
                    specialsHtml += venue.specialsDrinks.map(item => `<div style="margin-top: 4px;">‚Ä¢ ${item}</div>`).join('');
                }
            }

            // TODO: "Today: <status> + Show full schedule" row intentionally mirrors Business Hours layout for consistency and scannability
            return `
                <div>
                    <div class="hh-section-heading">Happy Hour Times</div>
                    <div class="hh-header-row">
                        <div class="hh-status-left">
                            <span class="hh-today-label">Today:</span>
                            <span class="hours-status-text">${hhStatus.text}</span>
                        </div>
                        <div class="hh-schedule-link" onclick="toggleHappyHourSchedule()">
                            <span class="hours-disclosure" id="hh-schedule-disclosure">‚ñæ</span>
                            <span id="hh-schedule-toggle-text">Show full schedule</span>
                        </div>
                    </div>
                    <div class="hours-weekly" id="hh-schedule-weekly">
                        ${scheduleHtml}
                    </div>
                </div>
                ${specialsHtml}
            `;
        }

        // Toggle HH schedule expand/collapse
        function toggleHappyHourSchedule() {
            const schedule = document.getElementById('hh-schedule-weekly');
            const disclosure = document.getElementById('hh-schedule-disclosure');
            const toggleText = document.getElementById('hh-schedule-toggle-text');
            const scrollContainer = document.getElementById('venue-detail-scroll');

            if (!schedule || !disclosure || !toggleText) return;

            const isExpanding = !schedule.classList.contains('visible');

            // For collapsing: measure position before to prevent scroll jump
            let scrollBefore, elementTop;
            if (!isExpanding && scrollContainer) {
                scrollBefore = scrollContainer.scrollTop;
                elementTop = schedule.offsetTop;
            }

            if (isExpanding) {
                schedule.classList.add('visible');
                disclosure.classList.add('expanded');
                toggleText.textContent = 'Hide full schedule';
            } else {
                schedule.classList.remove('visible');
                disclosure.classList.remove('expanded');
                toggleText.textContent = 'Show full schedule';

                // Adjust scroll if user was scrolled within the collapsed section
                if (scrollContainer && scrollBefore > elementTop) {
                    const scrollDelta = scrollBefore - elementTop;
                    scrollContainer.scrollTop = elementTop;
                }
            }
        }

        // TODO: Alpha uses placeholder data. Future: fields may be missing/null.
        // Render venue Info section with conditional display of rows
        function renderVenueInfo(venue) {
            const container = document.getElementById('venue-info-container');
            if (!container) return;

            let html = '';

            // 1) Business Hours - with Open/Closed status
            if (venue.hoursWeekly) {
                const status = calculateBusinessHoursStatus(venue.hoursWeekly);
                const hasWeekly = Object.keys(venue.hoursWeekly).length > 0;

                html += `
                    <div class="info-list-row">
                        <div class="info-row-content">
                            <div class="info-row-label">Business Hours</div>
                            <div>
                                <div class="hours-status">
                                    <span class="hours-status-badge ${status.isOpen ? 'open' : 'closed'}">${status.status}</span>
                                    <span class="hours-status-text">¬∑ ${status.text}</span>
                                    ${hasWeekly ? `
                                        <span class="hours-toggle" onclick="toggleWeeklyHours()">
                                            <span class="hours-disclosure" id="hours-disclosure">‚ñæ</span>
                                            <span id="hours-toggle-text">Show full hours</span>
                                        </span>
                                    ` : ''}
                                </div>
                                ${hasWeekly ? `
                                    <div class="hours-weekly" id="hours-weekly">
                                        ${Object.entries(venue.hoursWeekly).map(([day, time]) => `
                                            <div class="hours-day-row">
                                                <span class="hours-day-name">${day}</span>
                                                <span class="hours-day-time">${time}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            // 2) Address (tappable ‚Üí open in Maps)
            if (venue.address) {
                html += `
                    <button class="info-list-row-action" onclick="openMapApp()">
                        <div class="info-row-content">
                            <div class="info-row-label">Address</div>
                            <div class="info-row-value">${venue.address}</div>
                        </div>
                        <div class="info-row-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                <circle cx="12" cy="10" r="3"></circle>
                            </svg>
                        </div>
                    </button>
                `;
            }

            // 3) Menu (tappable ‚Üí open menu URL or website)
            if (venue.menuUrl || venue.websiteUrl) {
                const menuTarget = venue.menuUrl || venue.websiteUrl;
                html += `
                    <button class="info-list-row-action" onclick="openVenueMenu('${menuTarget}')">
                        <div class="info-row-content">
                            <div class="info-row-label">Menu</div>
                            <div class="info-row-value">View menu</div>
                        </div>
                        <div class="info-row-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                <polyline points="15 3 21 3 21 9"></polyline>
                                <line x1="10" y1="14" x2="21" y2="3"></line>
                            </svg>
                        </div>
                    </button>
                `;
            }

            // 4) Phone (tappable ‚Üí click-to-call)
            if (venue.phone) {
                html += `
                    <button class="info-list-row-action" onclick="callVenue()">
                        <div class="info-row-content">
                            <div class="info-row-label">Phone</div>
                            <div class="info-row-value">${venue.phone}</div>
                        </div>
                        <div class="info-row-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                            </svg>
                        </div>
                    </button>
                `;
            }

            // 5) Payment Methods (text display, not tappable)
            if (venue.paymentMethods) {
                html += `
                    <div class="info-list-row">
                        <div class="info-row-content">
                            <div class="info-row-label">Payment</div>
                            <div class="info-row-value">${venue.paymentMethods}</div>
                        </div>
                    </div>
                `;
            }

            // 6) Website (tappable ‚Üí open externally)
            if (venue.websiteUrl) {
                html += `
                    <button class="info-list-row-action" onclick="openVenueWebsiteExternal('${venue.websiteUrl}')">
                        <div class="info-row-content">
                            <div class="info-row-label">Website</div>
                            <div class="info-row-value">${venue.websiteUrl.replace('https://', '').replace('http://', '')}</div>
                        </div>
                        <div class="info-row-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                <polyline points="15 3 21 3 21 9"></polyline>
                                <line x1="10" y1="14" x2="21" y2="3"></line>
                            </svg>
                        </div>
                    </button>
                `;
            }

            container.innerHTML = html;
        }

        // Render Venue CTAs conditionally based on available URLs
        function renderVenueCTAs(venue) {
            const container = document.getElementById('venue-action-buttons');
            if (!container) return;

            let ctaHTML = '';

            // Reservations CTA - only if reservationUrl exists
            if (venue.reservationUrl) {
                ctaHTML += `
                    <button class="venue-action-btn" onclick="window.open('${venue.reservationUrl}', '_blank')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        <span>Reserve</span>
                    </button>
                `;
            }

            // Call CTA - only if phone exists
            if (venue.phone) {
                ctaHTML += `
                    <button class="venue-action-btn" onclick="callVenue()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                        </svg>
                        <span>Call</span>
                    </button>
                `;
            }

            // Website CTA - only if websiteUrl exists
            if (venue.websiteUrl) {
                ctaHTML += `
                    <button class="venue-action-btn" onclick="openVenueWebsite()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="2" y1="12" x2="22" y2="12"></line>
                            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                        </svg>
                        <span>Website</span>
                    </button>
                `;
            }

            container.innerHTML = ctaHTML;
        }

        function showVenueDetail(venueName) {
            const venue = venues[venueName];
            if (!venue) return;

            currentVenue = venue;
            currentVenueName = venueName;

            // Sync venue detail header bookmark state with central saved state
            const venueSaveBtn = document.getElementById('venue-save-btn');
            if (venueSaveBtn) {
                if (savedVenues.has(venueName)) {
                    venueSaveBtn.classList.add('saved');
                } else {
                    venueSaveBtn.classList.remove('saved');
                }
            }

            // Update header
            document.getElementById('venue-detail-title').textContent = venueName;

            // Update hero image - use category-based images like listings with fallback
            const heroImage = document.getElementById('venue-hero-image');
            let imagePath = 'images/default-1.jpg';
            if (venue.type.includes('Fine Dining') || venue.type.includes('Upscale')) {
                imagePath = 'images/fine-dining-1.jpg';
            } else if (venue.type.includes('Sports Bar')) {
                imagePath = 'images/sports-bar-1.jpg';
            } else if (venue.type.includes('Casual') || venue.type.includes('Family')) {
                imagePath = 'images/casual-dining-1.jpg';
            }

            // Test if image loads successfully, otherwise show fallback
            heroImage.classList.remove('fallback');
            const testImage = new Image();
            testImage.onload = function() {
                heroImage.style.backgroundImage = `url('${imagePath}')`;
                heroImage.classList.remove('fallback');
            };
            testImage.onerror = function() {
                heroImage.style.backgroundImage = 'none';
                heroImage.classList.add('fallback');
            };
            testImage.src = imagePath;

            // Set initial background while testing
            heroImage.style.backgroundImage = `url('${imagePath}')`;

            // Update venue name and meta
            document.getElementById('venue-name-large').textContent = venueName;
            document.getElementById('venue-status').textContent = 'Open Now';
            document.getElementById('venue-distance').textContent = formatDistance(venue) || '';
            document.getElementById('venue-category').textContent = `‚Ä¢ ${venue.type}`;

            // Update Happy Hour section with new multi-window support
            document.getElementById('venue-happy-hour-box').innerHTML = renderHappyHourSection(venue);

            // Render CTAs conditionally based on available data
            renderVenueCTAs(venue);

            // Render Info section with conditional rows
            renderVenueInfo(venue);

            // Get scroll container reference
            const scrollContainer = document.getElementById('venue-detail-scroll');
            const collapsibleHeader = document.getElementById('venue-header-collapsible');

            // Reset scroll position BEFORE showing screen
            scrollContainer.scrollTop = 0;
            collapsibleHeader.classList.remove('collapsed');

            // Show screen
            showScreen('detail-screen');

            // CRITICAL: Force scroll reset AFTER screen is visible
            // This prevents browser history restoration from overriding our reset
            requestAnimationFrame(() => {
                scrollContainer.scrollTop = 0;
                collapsibleHeader.classList.remove('collapsed');

                // Also reset after a short delay to catch any delayed browser restore
                setTimeout(() => {
                    scrollContainer.scrollTop = 0;
                    collapsibleHeader.classList.remove('collapsed');
                }, 0);

                // Initialize map
                initializeVenueDetailMap();
                setTimeout(initializeVenueDetailMap, 100);
                setTimeout(initializeVenueDetailMap, 300);
                setTimeout(initializeVenueDetailMap, 500);
            });

            // Setup tabs (click-only, no scroll tracking)
            // This also resets active tab to Happy Hour default
            setupVenueDetailTabs();
        }

        // ========================================
        // VENUE DETAIL TABS WITH SCROLL TRACKING
        // ========================================
        // Tabs act as jump links AND update based on scroll position

        function setupVenueDetailTabs() {
            // Get tab elements
            const tabHappyHour = document.getElementById('tab-happyhour');
            const tabInfo = document.getElementById('tab-info');

            if (!tabHappyHour || !tabInfo) {
                console.error('Venue tabs not found');
                return;
            }

            // Set default active tab (Happy Hour)
            setActiveVenueTab('happyhour');

            // Attach scroll listener to update chip highlighting
            const scrollContainer = document.getElementById('venue-detail-scroll');
            if (scrollContainer) {
                // Remove existing listener if any
                scrollContainer.removeEventListener('scroll', handleVenueDetailScroll);
                // Add new listener
                scrollContainer.addEventListener('scroll', handleVenueDetailScroll);
            }
        }

        // Set active chip state (visual only - inline styles)
        function setActiveVenueTab(tabName) {
            const tabHappyHour = document.getElementById('tab-happyhour');
            const tabInfo = document.getElementById('tab-info');

            if (!tabHappyHour || !tabInfo) return;

            // Reset both chips to inactive state (outlined)
            tabHappyHour.style.background = 'white';
            tabHappyHour.style.borderColor = '#d1d5db';
            tabHappyHour.style.fontWeight = '500';
            tabHappyHour.style.color = '#6b7280';

            tabInfo.style.background = 'white';
            tabInfo.style.borderColor = '#d1d5db';
            tabInfo.style.fontWeight = '500';
            tabInfo.style.color = '#6b7280';

            // Activate the selected chip (filled blue)
            if (tabName === 'happyhour') {
                tabHappyHour.style.background = '#3b82f6';
                tabHappyHour.style.borderColor = '#3b82f6';
                tabHappyHour.style.fontWeight = '600';
                tabHappyHour.style.color = 'white';
            } else if (tabName === 'info') {
                tabInfo.style.background = '#3b82f6';
                tabInfo.style.borderColor = '#3b82f6';
                tabInfo.style.fontWeight = '600';
                tabInfo.style.color = 'white';
            }
        }

        // Click handler - scrolls to anchor AND sets active tab
        function scrollToVenueSection(sectionName) {
            // Target the scroll anchor (not the section) for proper positioning
            const anchor = document.getElementById(`anchor-${sectionName}`);

            if (!anchor) {
                console.error(`Anchor not found: anchor-${sectionName}`);
                return;
            }

            // Update active tab state
            setActiveVenueTab(sectionName);

            // Scroll to anchor using scrollIntoView
            // This positions the section title below sticky header + tabs
            anchor.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }

        // Handle venue detail scroll to update active chip based on section in view
        function handleVenueDetailScroll() {
            const scrollContainer = document.getElementById('venue-detail-scroll');
            if (!scrollContainer) return;

            const scrollTop = scrollContainer.scrollTop;
            const happyHourAnchor = document.getElementById('anchor-happyhour');
            const infoAnchor = document.getElementById('anchor-info');

            if (!happyHourAnchor || !infoAnchor) return;

            // Calculate section positions relative to scroll container
            const happyHourTop = happyHourAnchor.offsetTop;
            const infoTop = infoAnchor.offsetTop;

            // Add offset for sticky header + chips (~100px)
            const scrollOffset = scrollTop + 100;

            // Determine which section is in view
            if (scrollOffset >= infoTop) {
                setActiveVenueTab('info');
            } else if (scrollOffset >= happyHourTop) {
                setActiveVenueTab('happyhour');
            }
        }

        // Toggle venue save from detail page header
        function toggleVenueSave(event) {
            event.stopPropagation();
            if (currentVenueName) {
                toggleVenueSavedState(currentVenueName);
            }
        }

        // Share venue
        function shareVenue() {
            if (currentVenueName && navigator.share) {
                navigator.share({
                    title: currentVenueName,
                    text: `Check out ${currentVenueName} on Happy Hour Compass!`,
                    url: window.location.href
                }).catch(err => console.log('Error sharing:', err));
            } else {
                alert(`Share: ${currentVenueName}`);
            }
        }

        // Call venue
        function callVenue() {
            if (currentVenue && currentVenue.phone) {
                window.location.href = `tel:${currentVenue.phone}`;
            }
        }

        // Open venue website (legacy - kept for backward compatibility)
        function openVenueWebsite() {
            if (currentVenue && currentVenue.websiteUrl) {
                window.open(currentVenue.websiteUrl, '_blank');
            } else {
                alert('Website not available');
            }
        }

        // Open venue website externally (new - for Info section)
        function openVenueWebsiteExternal(url) {
            if (url) {
                window.open(url, '_blank');
            }
        }

        // Open venue menu
        function openVenueMenu(url) {
            if (url) {
                window.open(url, '_blank');
            }
        }

        // Toggle weekly hours expansion
        function toggleWeeklyHours() {
            const weeklyDiv = document.getElementById('hours-weekly');
            const disclosure = document.getElementById('hours-disclosure');
            const toggleText = document.getElementById('hours-toggle-text');

            if (!weeklyDiv || !disclosure || !toggleText) return;

            const isVisible = weeklyDiv.classList.contains('visible');

            if (isVisible) {
                weeklyDiv.classList.remove('visible');
                disclosure.classList.remove('expanded');
                toggleText.textContent = 'Show full hours';
            } else {
                weeklyDiv.classList.add('visible');
                disclosure.classList.add('expanded');
                toggleText.textContent = 'Hide full hours';
            }
        }

        // Open Google Maps with venue address
        function openGoogleMaps() {
            if (currentVenue && currentVenue.address) {
                const address = encodeURIComponent(currentVenue.address);
                window.open(`https://maps.google.com/?q=${address}`, '_blank');
            }
        }

        // Open Apple Maps with venue address
        function openAppleMaps() {
            if (currentVenue && currentVenue.address) {
                const address = encodeURIComponent(currentVenue.address);
                window.open(`https://maps.apple.com/?q=${address}`, '_blank');
            }
        }

        // Legacy - kept for backward compatibility with Address row
        function openMapApp() {
            openGoogleMaps();
        }

        // Expand map to full view
        function expandMap() {
            const modal = document.getElementById('map-modal');
            modal.style.display = 'flex';
            document.getElementById('map-modal-title').textContent = currentVenueName || 'Venue Location';

            // Initialize expanded map
            setTimeout(() => {
                initializeExpandedMap();
            }, 100);
        }

        // Close expanded map
        function closeExpandedMap() {
            const modal = document.getElementById('map-modal');
            modal.style.display = 'none';
        }

        // Initialize expanded map
        let expandedMap = null;
        function initializeExpandedMap() {
            const container = document.getElementById('detail-map-expanded');

            if (!container) return;

            if (expandedMap) {
                expandedMap.remove();
            }

            expandedMap = L.map('detail-map-expanded').setView([49.8880, -119.4960], 15);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(expandedMap);

            const customIcon = L.divIcon({
                className: 'custom-marker',
                html: createCustomMarker(),
                iconSize: [40, 40],
                iconAnchor: [20, 40]
            });

            L.marker([49.8880, -119.4960], { icon: customIcon }).addTo(expandedMap);

            setTimeout(() => {
                if (expandedMap) {
                    expandedMap.invalidateSize();
                }
            }, 100);
        }

        // ========================================
        // EVENTS SEARCH, FILTERING, AND CALENDAR
        // ========================================

        let currentEventsFilter = null; // No filter active by default
        let selectedEventDateStart = null;
        let selectedEventDateEnd = null;

        // Toggle events search (reuse Favorites pattern)
        function toggleEventsSearch() {
            const searchContainer = document.getElementById('events-search-container');
            const searchToggleBtn = document.getElementById('events-search-toggle');
            const searchInput = document.getElementById('events-search-input');

            if (searchContainer.classList.contains('active')) {
                // Close search
                searchContainer.classList.remove('active');
                searchToggleBtn.textContent = 'üîç';
                searchInput.value = '';
                performEventsSearch(); // Reset filter
            } else {
                // Open search
                searchContainer.classList.add('active');
                searchToggleBtn.textContent = '‚úï';
                setTimeout(() => searchInput.focus(), 100);
            }
        }

        // Perform search on events
        function performEventsSearch() {
            const searchTerm = document.getElementById('events-search-input')?.value.toLowerCase() || '';
            const eventsContent = document.getElementById('events-content');
            const eventItems = eventsContent.querySelectorAll('.event-item');

            if (searchTerm.length === 0) {
                // No search term - apply only filters
                applyEventFilters();
                return;
            }

            // Search with filters combined
            eventItems.forEach(item => {
                const eventTitle = item.querySelector('.event-title')?.textContent.toLowerCase() || '';
                const eventVenue = item.querySelector('.event-venue')?.textContent.toLowerCase() || '';

                // Use data-event-id attribute first, fall back to onclick parsing
                let eventId = item.getAttribute('data-event-id');
                if (!eventId) {
                    const onclickAttr = item.getAttribute('onclick') || '';
                    const match = onclickAttr.match(/showEventDetail\(['"](.+?)['"]\)/);
                    eventId = match ? match[1] : null;
                }

                const matchesSearch = eventTitle.includes(searchTerm) || eventVenue.includes(searchTerm);
                const matchesFilter = eventId ? eventMatchesFilter(eventId) : true;

                if (matchesSearch && matchesFilter) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });

            checkEventsEmpty();
        }

        // Filter events by chip selection (toggle behavior: tap again to deselect)
        function filterEventsBy(filter) {
            // If tapping the already-active filter, toggle it off (return to no filter)
            if (currentEventsFilter === filter) {
                currentEventsFilter = null;
            } else {
                currentEventsFilter = filter;
            }

            selectedEventDateStart = null; // Clear calendar selection
            selectedEventDateEnd = null;

            // Update chip active states
            const todayChip = document.getElementById('events-chip-today');
            const weekendChip = document.getElementById('events-chip-weekend');

            todayChip.classList.remove('active');
            weekendChip.classList.remove('active');

            if (currentEventsFilter === 'today') {
                todayChip.classList.add('active');
            } else if (currentEventsFilter === 'weekend') {
                weekendChip.classList.add('active');
            }
            // If currentEventsFilter is null, no chips are active (correct behavior)

            // Apply the filter to event items
            applyEventFilters();
        }

        // Helper: Parse ISO date string (YYYY-MM-DD) to local Date object
        // This avoids timezone issues with new Date('YYYY-MM-DD') which parses as UTC
        function parseLocalDate(dateStr) {
            const [year, month, day] = dateStr.split('-').map(Number);
            return new Date(year, month - 1, day); // month is 0-indexed
        }

        // Helper: Check if an event's dayOfWeek falls within a date range
        function eventDayFallsInRange(eventDayOfWeek, startDateStr, endDateStr) {
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const dayIndex = dayNames.findIndex(d => d.toLowerCase() === eventDayOfWeek.toLowerCase());

            if (dayIndex === -1) return false;

            // Parse dates as local dates to avoid timezone issues
            const startDate = parseLocalDate(startDateStr);
            const endDate = parseLocalDate(endDateStr);

            // Iterate through each day in the range
            const currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                if (currentDate.getDay() === dayIndex) {
                    return true;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return false;
        }

        // Check if an event matches the current filter
        function eventMatchesFilter(eventIdOrName) {
            const event = getEvent(eventIdOrName);
            if (!event) return false;

            const now = new Date();
            const currentDay = now.getDay(); // 0 = Sunday
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const todayName = dayNames[currentDay];

            // Use explicit dayOfWeek field if available, otherwise parse schedule
            const eventDay = event.dayOfWeek || '';
            const schedule = (event.schedule || '').toLowerCase();

            if (currentEventsFilter === 'today') {
                // Check if event runs today using dayOfWeek field first
                if (eventDay) {
                    return eventDay.toLowerCase() === todayName.toLowerCase();
                }
                // Fallback: parse schedule string
                if (schedule.includes('every')) {
                    return schedule.includes(todayName.toLowerCase());
                }
                return schedule.includes(todayName.toLowerCase());
            } else if (currentEventsFilter === 'weekend') {
                // Weekend = Saturday or Sunday
                if (eventDay) {
                    const dayLower = eventDay.toLowerCase();
                    return dayLower === 'saturday' || dayLower === 'sunday';
                }
                // Fallback: parse schedule string
                return schedule.includes('saturday') || schedule.includes('sunday');
            } else if (currentEventsFilter === 'custom' && selectedEventDateStart && selectedEventDateEnd) {
                // Custom calendar date range filter
                // For recurring events, check if the event's dayOfWeek falls within the date range
                if (eventDay) {
                    return eventDayFallsInRange(eventDay, selectedEventDateStart, selectedEventDateEnd);
                }
                // For events without dayOfWeek, show them (permissive for now)
                return true;
            }

            // If no filter or unknown filter, show all
            return true;
        }

        // Apply event filters to the list
        function applyEventFilters() {
            const eventItems = document.querySelectorAll('#events-content .event-item');

            eventItems.forEach(item => {
                // Use data-event-id attribute first (from render functions), fall back to onclick parsing
                let eventId = item.getAttribute('data-event-id');
                if (!eventId) {
                    // Fallback: extract event name from onclick attribute
                    const onclickAttr = item.getAttribute('onclick') || '';
                    const match = onclickAttr.match(/showEventDetail\(['"](.+?)['"]\)/);
                    eventId = match ? match[1] : null;
                }

                if (eventId && eventMatchesFilter(eventId)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });

            checkEventsEmpty();
        }

        // Custom Calendar State
        let calendarCurrentMonth = new Date();
        let calendarSelectedStart = null;
        let calendarSelectedEnd = null;
        let calendarAppliedStart = null;
        let calendarAppliedEnd = null;
        let calendarActiveField = 'from'; // 'from' or 'to'

        // Set active field (from or to)
        function setActiveField(field) {
            calendarActiveField = field;

            // Update visual indicators
            const fromField = document.getElementById('date-field-from');
            const toField = document.getElementById('date-field-to');
            const helperText = document.getElementById('calendar-helper-text');

            if (field === 'from') {
                fromField.classList.add('active');
                toField.classList.remove('active');
                helperText.textContent = 'Select a start date';
            } else {
                fromField.classList.remove('active');
                toField.classList.add('active');
                helperText.textContent = 'Select an end date';
            }
        }

        // Update From/To field displays
        function updateFromToFields() {
            const fromValue = document.getElementById('date-field-from-value');
            const toValue = document.getElementById('date-field-to-value');

            if (calendarSelectedStart) {
                const formatted = formatDateForFieldDisplay(calendarSelectedStart);
                fromValue.textContent = formatted;
                fromValue.classList.remove('placeholder');
            } else {
                fromValue.textContent = 'Select start';
                fromValue.classList.add('placeholder');
            }

            if (calendarSelectedEnd) {
                const formatted = formatDateForFieldDisplay(calendarSelectedEnd);
                toValue.textContent = formatted;
                toValue.classList.remove('placeholder');
            } else {
                toValue.textContent = 'Select end';
                toValue.classList.add('placeholder');
            }
        }

        // Format date for From/To field display (e.g., "Thu, Jan 8")
        function formatDateForFieldDisplay(date) {
            const options = { weekday: 'short', month: 'short', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        // Toggle custom calendar picker
        function toggleEventsCalendar() {
            const calendarPicker = document.getElementById('events-calendar-picker');

            if (calendarPicker.style.display === 'none') {
                // Opening calendar
                const today = new Date();

                // Initialize selection to today if no prior applied range
                if (!calendarAppliedStart && !calendarAppliedEnd) {
                    calendarSelectedStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                    calendarSelectedEnd = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                } else {
                    // Restore applied range
                    calendarSelectedStart = calendarAppliedStart ? new Date(calendarAppliedStart) : new Date(today.getFullYear(), today.getMonth(), today.getDate());
                    calendarSelectedEnd = calendarAppliedEnd ? new Date(calendarAppliedEnd) : new Date(today.getFullYear(), today.getMonth(), today.getDate());
                }

                // Set current month to the start date's month
                calendarCurrentMonth = new Date(calendarSelectedStart.getFullYear(), calendarSelectedStart.getMonth(), 1);

                // Default to selecting From field
                calendarActiveField = 'from';
                setActiveField('from');

                // Update From/To field displays
                updateFromToFields();

                // Render calendar
                renderCalendar();

                calendarPicker.style.display = 'block';
            } else {
                // Closing calendar without applying - discard changes
                calendarPicker.style.display = 'none';
            }
        }

        // Render calendar grid for current month
        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const monthLabel = document.getElementById('calendar-month-label');
            const prevBtn = document.getElementById('calendar-prev-month');

            if (!grid || !monthLabel) return;

            // Update month label
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            monthLabel.textContent = `${monthNames[calendarCurrentMonth.getMonth()]} ${calendarCurrentMonth.getFullYear()}`;

            // Disable prev button if it would go into past months
            const today = new Date();
            const currentMonthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            const prevMonthStart = new Date(calendarCurrentMonth.getFullYear(), calendarCurrentMonth.getMonth() - 1, 1);

            if (prevBtn) {
                prevBtn.disabled = prevMonthStart < currentMonthStart;
            }

            // Calculate days in month and starting day of week
            const year = calendarCurrentMonth.getFullYear();
            const month = calendarCurrentMonth.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Clear grid
            grid.innerHTML = '';

            // Add empty cells for days before month start
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day empty';
                grid.appendChild(emptyDay);
            }

            // Add day cells
            const todayDate = new Date();
            todayDate.setHours(0, 0, 0, 0);

            for (let day = 1; day <= daysInMonth; day++) {
                const dayDate = new Date(year, month, day);
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                dayCell.textContent = day;
                dayCell.dataset.date = dayDate.toISOString().split('T')[0];

                // Check if past date
                const isPast = dayDate < todayDate;
                if (isPast) {
                    dayCell.classList.add('disabled');
                } else {
                    dayCell.onclick = () => handleDayClick(dayDate);
                }

                // Check if today
                if (dayDate.getTime() === todayDate.getTime()) {
                    dayCell.classList.add('today');
                }

                // Apply range selection classes
                applyCellRangeStyle(dayCell, dayDate);

                grid.appendChild(dayCell);
            }
        }

        // Apply range selection styling to a day cell
        function applyCellRangeStyle(dayCell, dayDate) {
            if (!calendarSelectedStart || !calendarSelectedEnd) return;

            const cellTime = dayDate.getTime();
            const startTime = calendarSelectedStart.getTime();
            const endTime = calendarSelectedEnd.getTime();

            // Check if start date
            if (cellTime === startTime) {
                dayCell.classList.add('range-start');
            }

            // Check if end date
            if (cellTime === endTime && startTime !== endTime) {
                dayCell.classList.add('range-end');
            }

            // Check if in-range (strictly between start and end)
            if (cellTime > startTime && cellTime < endTime) {
                dayCell.classList.add('in-range');
            }
        }

        // Handle day cell click (guided From/To selection logic)
        function handleDayClick(clickedDate) {
            const clickedTime = clickedDate.getTime();

            if (calendarActiveField === 'from') {
                // Setting From (start date)
                calendarSelectedStart = clickedDate;

                // If end date is now before start date, set end = start
                if (calendarSelectedEnd && calendarSelectedEnd.getTime() < clickedTime) {
                    calendarSelectedEnd = clickedDate;
                }

                // Switch to selecting To field
                setActiveField('to');
            } else {
                // Setting To (end date)
                const startTime = calendarSelectedStart ? calendarSelectedStart.getTime() : null;

                if (clickedTime < startTime) {
                    // User clicked before start date - treat as new start
                    calendarSelectedStart = clickedDate;
                    calendarSelectedEnd = clickedDate;
                    // Keep active field as 'to' (user still choosing end)
                } else {
                    // Normal case - set end date
                    calendarSelectedEnd = clickedDate;
                }
            }

            // Update From/To field displays
            updateFromToFields();

            // Re-render calendar to update styling
            renderCalendar();
        }

        // Navigate to previous/next month
        function navigateCalendarMonth(direction) {
            calendarCurrentMonth = new Date(calendarCurrentMonth.getFullYear(), calendarCurrentMonth.getMonth() + direction, 1);
            renderCalendar();
        }

        // Format date for human-readable display (e.g., "Jan 8, 2026")
        function formatDateForDisplay(date) {
            const options = { month: 'short', day: 'numeric', year: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        // Apply calendar range filter
        function applyCalendarRange() {
            if (!calendarSelectedStart || !calendarSelectedEnd) return;

            // Save applied range
            calendarAppliedStart = new Date(calendarSelectedStart);
            calendarAppliedEnd = new Date(calendarSelectedEnd);

            // Store in ISO format for filtering
            selectedEventDateStart = calendarAppliedStart.toISOString().split('T')[0];
            selectedEventDateEnd = calendarAppliedEnd.toISOString().split('T')[0];

            // Clear chip selections
            document.getElementById('events-chip-today').classList.remove('active');
            document.getElementById('events-chip-weekend').classList.remove('active');
            currentEventsFilter = 'custom';

            // Apply the filter to show events matching the date range
            applyEventFilters();

            // Close calendar
            toggleEventsCalendar();
        }

        // Clear calendar range filter
        function clearCalendarRange() {
            // Clear all calendar state
            calendarSelectedStart = null;
            calendarSelectedEnd = null;
            calendarAppliedStart = null;
            calendarAppliedEnd = null;
            selectedEventDateStart = null;
            selectedEventDateEnd = null;

            // Close calendar
            toggleEventsCalendar();

            // Reset to "Happening Today"
            filterEventsBy('today');
        }

        // Check if events list is empty and show/hide empty state
        function checkEventsEmpty() {
            const eventsContent = document.getElementById('events-content');
            const emptyState = document.getElementById('events-empty-state');
            const eventItems = eventsContent?.querySelectorAll('.event-item') || [];

            const visibleCount = Array.from(eventItems).filter(item => {
                return item.style.display !== 'none';
            }).length;

            if (emptyState) {
                emptyState.style.display = visibleCount === 0 ? 'flex' : 'none';
            }
        }

        // Store current event data
        let currentEventData = null;

        // Render Event CTAs conditionally based on available URLs
        function renderEventCTAs(event) {
            const container = document.getElementById('event-action-buttons');
            if (!container) return;

            // Look up the venue to access its website URL
            const venue = venues[event.venue];

            let ctaHTML = '';

            // Buy Tickets CTA - only if ticketUrl exists
            if (event.ticketUrl) {
                ctaHTML += `
                    <button class="venue-action-btn" onclick="window.open('${event.ticketUrl}', '_blank')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path>
                        </svg>
                        <span>Tickets</span>
                    </button>
                `;
            }

            // Call CTA - only if phone exists
            if (event.phone) {
                ctaHTML += `
                    <button class="venue-action-btn" onclick="callEventVenue()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                        </svg>
                        <span>Call</span>
                    </button>
                `;
            }

            // Website CTA - use venue's websiteUrl (same as Venue Detail)
            if (venue && venue.websiteUrl) {
                ctaHTML += `
                    <button class="venue-action-btn" onclick="openEventWebsite()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="2" y1="12" x2="22" y2="12"></line>
                            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                        </svg>
                        <span>Website</span>
                    </button>
                `;
            }

            container.innerHTML = ctaHTML;
        }

        function showEventDetail(eventName) {
            const event = events[eventName];
            if (!event) return;

            // Store current event data
            currentEventData = { name: eventName, ...event };

            // Sync event detail header bookmark state with central saved state
            const eventSaveBtn = document.getElementById('event-save-btn');
            if (eventSaveBtn) {
                if (savedEvents.has(eventName)) {
                    eventSaveBtn.classList.add('saved');
                } else {
                    eventSaveBtn.classList.remove('saved');
                }
            }

            // Update header
            document.getElementById('event-detail-title').textContent = eventName;

            // Update hero image (remove text overlay)
            const eventHeroImage = document.getElementById('event-hero-image');
            if (event.image) {
                eventHeroImage.style.backgroundImage = `url('${event.image}')`;
                eventHeroImage.style.backgroundSize = 'cover';
                eventHeroImage.style.backgroundPosition = 'center';
            } else {
                // Fallback to gradient if no image
                eventHeroImage.style.backgroundImage = 'linear-gradient(135deg, #ef4444, #f97316)';
            }

            // Update event core info
            document.getElementById('event-name-large').textContent = eventName;

            // Get venue name using venueId from data model
            const eventVenue = getVenueForEvent(event);
            const venueName = eventVenue ? eventVenue.name : (event.venue || 'Unknown Venue');
            document.getElementById('event-venue-name').textContent = venueName;

            // Format date/time
            const dateTime = formatEventDateTime(event);
            document.getElementById('event-date-time').textContent = dateTime;

            // Update Event section
            renderEventDetailsBox(event);

            // Render CTAs conditionally based on available data
            renderEventCTAs(event);

            // Update Venue section - look up actual venue data using venueId
            const venueData = getVenueForEvent(event);
            if (venueData) {
                renderEventVenueInfo(venueData);
            } else {
                // Fallback: render basic event info if venue not found
                const fallbackVenue = {
                    address: event.address,
                    phone: event.phone,
                    websiteUrl: event.website
                };
                renderEventVenueInfo(fallbackVenue);
            }

            // Get scroll container reference
            const scrollContainer = document.getElementById('event-detail-scroll');
            const collapsibleHeader = document.getElementById('event-header-collapsible');

            // Reset scroll position BEFORE showing screen
            scrollContainer.scrollTop = 0;
            collapsibleHeader.classList.remove('collapsed');

            // Show screen
            showScreen('event-detail-screen');

            // CRITICAL: Force scroll reset AFTER screen is visible
            // This prevents browser history restoration from overriding our reset
            requestAnimationFrame(() => {
                scrollContainer.scrollTop = 0;
                collapsibleHeader.classList.remove('collapsed');

                // Also reset after a short delay to catch any delayed browser restore
                setTimeout(() => {
                    scrollContainer.scrollTop = 0;
                    collapsibleHeader.classList.remove('collapsed');
                }, 0);
            });

            // Setup tabs and scroll tracking
            setupEventDetailTabs();
        }

        // Format event date/time for display
        function formatEventDateTime(event) {
            // Support two formats:
            // 1. One-off: "Jan 29 ‚Ä¢ 8 PM"
            // 2. Repeating: "Thursdays ‚Ä¢ 8 PM"
            return `${event.schedule} ‚Ä¢ ${event.time}`;
        }

        // Render Event Details box (reusing Happy Hour block structure)
        function renderEventDetailsBox(event) {
            const box = document.getElementById('event-details-box');
            const dateTime = formatEventDateTime(event);

            let html = `<strong>Date & Time</strong><br>${dateTime}`;
            html += `<br><br><strong>Overview</strong><br>${event.description}`;

            if (event.offers) {
                html += `<br><br><strong>Specials</strong><br>${event.offers}`;
            }

            box.innerHTML = html;
        }

        // Render Event Venue Info (EXACT clone of Venue Detail Info section)
        // This reuses the same structure, icons, and conditional logic as renderVenueInfo()
        function renderEventVenueInfo(venue) {
            const container = document.getElementById('event-venue-info-container');
            if (!container) return;

            let html = '';

            // 1) Business Hours - with Open/Closed status
            if (venue.hoursWeekly) {
                const status = calculateBusinessHoursStatus(venue.hoursWeekly);
                const hasWeekly = Object.keys(venue.hoursWeekly).length > 0;

                html += `
                    <div class="info-list-row">
                        <div class="info-row-content">
                            <div class="info-row-label">Business Hours</div>
                            <div>
                                <div class="hours-status">
                                    <span class="hours-status-badge ${status.isOpen ? 'open' : 'closed'}">${status.status}</span>
                                    <span class="hours-status-text">¬∑ ${status.text}</span>
                                    ${hasWeekly ? `
                                        <span class="hours-toggle" onclick="toggleEventWeeklyHours()">
                                            <span class="hours-disclosure" id="event-hours-disclosure">‚ñæ</span>
                                            <span id="event-hours-toggle-text">Show full hours</span>
                                        </span>
                                    ` : ''}
                                </div>
                                ${hasWeekly ? `
                                    <div class="hours-weekly" id="event-hours-weekly">
                                        ${Object.entries(venue.hoursWeekly).map(([day, time]) => `
                                            <div class="hours-day-row">
                                                <span class="hours-day-name">${day}</span>
                                                <span class="hours-day-time">${time}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            // 2) Address (tappable ‚Üí open in Maps)
            if (venue.address) {
                html += `
                    <button class="info-list-row-action" onclick="openEventMapApp()">
                        <div class="info-row-content">
                            <div class="info-row-label">Address</div>
                            <div class="info-row-value">${venue.address}</div>
                        </div>
                        <div class="info-row-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                <circle cx="12" cy="10" r="3"></circle>
                            </svg>
                        </div>
                    </button>
                `;
            }

            // 3) Menu (tappable ‚Üí open menu URL or website)
            if (venue.menuUrl || venue.websiteUrl) {
                const menuTarget = venue.menuUrl || venue.websiteUrl;
                html += `
                    <button class="info-list-row-action" onclick="openEventVenueMenu('${menuTarget}')">
                        <div class="info-row-content">
                            <div class="info-row-label">Menu</div>
                            <div class="info-row-value">View menu</div>
                        </div>
                        <div class="info-row-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                <polyline points="15 3 21 3 21 9"></polyline>
                                <line x1="10" y1="14" x2="21" y2="3"></line>
                            </svg>
                        </div>
                    </button>
                `;
            }

            // 4) Phone (tappable ‚Üí click-to-call)
            if (venue.phone) {
                html += `
                    <button class="info-list-row-action" onclick="callEventVenue()">
                        <div class="info-row-content">
                            <div class="info-row-label">Phone</div>
                            <div class="info-row-value">${venue.phone}</div>
                        </div>
                        <div class="info-row-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                            </svg>
                        </div>
                    </button>
                `;
            }

            // 5) Payment Methods (text display, not tappable)
            if (venue.paymentMethods) {
                html += `
                    <div class="info-list-row">
                        <div class="info-row-content">
                            <div class="info-row-label">Payment</div>
                            <div class="info-row-value">${venue.paymentMethods}</div>
                        </div>
                    </div>
                `;
            }

            // 6) Website (tappable ‚Üí open externally)
            if (venue.websiteUrl) {
                html += `
                    <button class="info-list-row-action" onclick="openEventVenueWebsiteExternal('${venue.websiteUrl}')">
                        <div class="info-row-content">
                            <div class="info-row-label">Website</div>
                            <div class="info-row-value">${venue.websiteUrl.replace('https://', '').replace('http://', '')}</div>
                        </div>
                        <div class="info-row-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                <polyline points="15 3 21 3 21 9"></polyline>
                                <line x1="10" y1="14" x2="21" y2="3"></line>
                            </svg>
                        </div>
                    </button>
                `;
            }

            container.innerHTML = html;
        }

        // Event-specific venue action handlers
        function toggleEventWeeklyHours() {
            const hoursContainer = document.getElementById('event-hours-weekly');
            const disclosure = document.getElementById('event-hours-disclosure');
            const toggleText = document.getElementById('event-hours-toggle-text');

            if (hoursContainer && disclosure && toggleText) {
                if (hoursContainer.classList.contains('visible')) {
                    hoursContainer.classList.remove('visible');
                    disclosure.classList.remove('expanded');
                    toggleText.textContent = 'Show full hours';
                } else {
                    hoursContainer.classList.add('visible');
                    disclosure.classList.add('expanded');
                    toggleText.textContent = 'Hide full hours';
                }
            }
        }

        function openEventMapApp() {
            if (!currentEventData || !currentEventData.address) return;
            const address = encodeURIComponent(currentEventData.address);
            window.open(`https://maps.google.com/?q=${address}`, '_blank');
        }

        function openEventVenueMenu(url) {
            window.open(url, '_blank');
        }

        function openEventVenueWebsiteExternal(url) {
            window.open(url, '_blank');
        }

        // Setup Event Detail tabs and scroll tracking
        function setupEventDetailTabs() {
            // Set default active tab
            setActiveEventTab('event');

            // Attach scroll listener
            const scrollContainer = document.getElementById('event-detail-scroll');
            if (scrollContainer) {
                scrollContainer.removeEventListener('scroll', handleEventDetailScroll);
                scrollContainer.addEventListener('scroll', handleEventDetailScroll);
            }
        }

        // Handle Event Detail scroll to update chip highlighting
        function handleEventDetailScroll() {
            const scrollContainer = document.getElementById('event-detail-scroll');
            if (!scrollContainer) return;

            const scrollTop = scrollContainer.scrollTop;
            const eventAnchor = document.getElementById('anchor-event');
            const venueAnchor = document.getElementById('anchor-venue');

            if (!eventAnchor || !venueAnchor) return;

            const eventTop = eventAnchor.offsetTop;
            const venueTop = venueAnchor.offsetTop;
            const scrollOffset = scrollTop + 100;

            if (scrollOffset >= venueTop) {
                setActiveEventTab('venue');
            } else if (scrollOffset >= eventTop) {
                setActiveEventTab('event');
            }
        }

        // Set active event tab
        function setActiveEventTab(tabId) {
            const tabs = document.querySelectorAll('#event-tabs .venue-tab');
            tabs.forEach(tab => tab.classList.remove('active'));

            const activeTab = document.getElementById(`tab-${tabId}`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
        }

        // Scroll to event section
        function scrollToEventSection(section) {
            const scrollContainer = document.getElementById('event-detail-scroll');
            const anchor = document.getElementById(`anchor-${section}`);

            if (scrollContainer && anchor) {
                const offsetTop = anchor.offsetTop - 10;
                scrollContainer.scrollTo({
                    top: offsetTop,
                    behavior: 'smooth'
                });
            }

            setActiveEventTab(section);
        }

        // Navigate to venue from event
        function navigateToVenueFromEvent() {
            if (!currentEventData || !currentEventData.venue) return;
            // Navigate to the venue detail page
            showVenueDetail(currentEventData.venue);
        }

        // Event action handlers
        function toggleEventSave(e) {
            e.stopPropagation();
            if (currentEventData && currentEventData.name) {
                toggleEventSavedState(currentEventData.name);
            }
        }

        function shareEvent() {
            if (currentEventData && navigator.share) {
                navigator.share({
                    title: currentEventData.name,
                    text: `Check out ${currentEventData.name} on Happy Hour Compass!`,
                    url: window.location.href
                }).catch(err => console.log('Error sharing:', err));
            } else if (currentEventData) {
                alert(`Share: ${currentEventData.name}`);
            }
        }

        function callEventVenue() {
            if (!currentEventData || !currentEventData.phone) return;
            window.location.href = `tel:${currentEventData.phone}`;
        }

        function openEventWebsite() {
            if (!currentEventData) return;
            // Use the venue's website URL (same as Venue Detail)
            const venue = venues[currentEventData.venue];
            if (venue && venue.websiteUrl) {
                window.open(venue.websiteUrl, '_blank');
            }
        }

        function goBack() {
            showScreen(previousScreen);
        }

        function updateNavHighlighting(screenId) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            let activeNavIndex;
            switch(screenId) {
                case 'search-screen':
                    activeNavIndex = 0;
                    break;
                case 'favorites-screen':
                    activeNavIndex = 1;
                    break;
                case 'events-screen':
                case 'create-ask-screen':
                case 'success-screen':
                case 'event-detail-screen':
                    activeNavIndex = 2;
                    break;
                default:
                    activeNavIndex = 0;
            }
            
            const navItems = document.querySelectorAll('.nav-item');
            if (navItems[activeNavIndex]) {
                navItems[activeNavIndex].classList.add('active');
            }
        }

        // Current view state
        let currentView = 'list';

        // SVG icons
        const mapPinIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>';
        const listIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>';

        function toggleViewInline() {
            const toggleIconSvg = document.getElementById('toggle-icon-svg');
            const toggleLabel = document.getElementById('toggle-label');
            const listContent = document.getElementById('list-content');
            const mapContent = document.getElementById('map-content');

            if (currentView === 'list') {
                // Switch to map view - show list icon (to go back to list)
                currentView = 'map';
                toggleIconSvg.innerHTML = listIcon;
                toggleLabel.textContent = 'List';
                listContent.style.display = 'none';
                mapContent.style.display = 'block';

                setTimeout(() => {
                    initializeMap();
                    if (map) {
                        map.invalidateSize();
                    }
                }, 100);
            } else {
                // Switch to list view - show map icon (to go to map)
                currentView = 'list';
                toggleIconSvg.innerHTML = mapPinIcon;
                toggleLabel.textContent = 'Map';
                listContent.style.display = 'block';
                mapContent.style.display = 'none';
            }
        }

        // Map functionality
        let map;
        let mapInitialized = false;

        function createCustomMarker() {
            return L.divIcon({
                className: 'custom-marker',
                html: '<div style="background: #ef4444; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 16px; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);">üìç</div>',
                iconSize: [30, 30],
                iconAnchor: [15, 15],
                popupAnchor: [0, -15]
            });
        }

        function initializeMap() {
            if (mapInitialized) return;
            
            map = L.map('map').setView([49.8880, -119.4960], 14);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            // Build map markers from venue data model (single source of truth for coords)
            venuesData.filter(v => v.latitude && v.longitude).forEach(venue => {
                const marker = L.marker([venue.latitude, venue.longitude], {
                    icon: createCustomMarker()
                }).addTo(map);
                
                marker.bindTooltip(`<strong>${venue.name}</strong><br>${venue.type}`, {
                    permanent: false,
                    direction: 'top',
                    offset: [0, -20]
                });

                const shortSpecials = getVenueShortSpecials(venue);
                marker.bindPopup(`
                    <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; cursor: pointer;" onclick="showVenueDetail('${venue.name}')">
                        <strong>${venue.name}</strong><br>
                        <div style="color: #6b7280; font-size: 14px; margin: 4px 0;">
                            ${shortSpecials}
                        </div>
                        <div style="color: #3b82f6; font-size: 12px; margin-top: 8px;">üìç Click to view details</div>
                    </div>
                `);
            });
            
            mapInitialized = true;
        }

        // Unified bookmark click handler - determines item type and name from DOM context
        function handleBookmarkClick(element) {
            // Find the parent card to determine type and identifier
            const listingItem = element.closest('.listing-item');
            const eventItem = element.closest('.event-item');

            if (listingItem) {
                // This is a venue bookmark - prefer data-venue-id, fall back to name
                const venueId = listingItem.getAttribute('data-venue-id');
                const venueName = listingItem.querySelector('.listing-name')?.textContent;
                const identifier = venueId || venueName;
                if (identifier) {
                    toggleVenueSavedState(identifier);
                }
            } else if (eventItem) {
                // This is an event bookmark - prefer data-event-id, fall back to name
                const eventId = eventItem.getAttribute('data-event-id');
                const eventName = eventItem.querySelector('.event-title')?.textContent;
                const identifier = eventId || eventName;
                if (identifier) {
                    toggleEventSavedState(identifier);
                }
            }
        }

        // Dismiss search empty state and clear search
        function dismissSearchEmptyState() {
            const searchInput = document.getElementById('search-input');

            // Clear search input
            if (searchInput) {
                searchInput.value = '';
            }

            // Clear all venue filters and reset chip states
            activeVenueFilters.clear();
            document.querySelectorAll('#search-filters .filter-chip').forEach(chip => {
                chip.classList.remove('active');
            });

            // Reapply filters (which will show all venues since no filters are active)
            applyVenueFilters();
        }

        // Close ask page and return to default search state
        function closeAskPage() {
            const searchInput = document.getElementById('search-input');

            // Clear search input
            if (searchInput) {
                searchInput.value = '';
            }

            // Clear all venue filters and reset chip states
            activeVenueFilters.clear();
            document.querySelectorAll('#search-filters .filter-chip').forEach(chip => {
                chip.classList.remove('active');
            });

            // Reapply filters (which will show all venues since no filters are active)
            applyVenueFilters();

            // Navigate to search screen
            showScreen('search-screen');
        }

        // Venue filter state
        let activeVenueFilters = new Set(); // No filters active by default

        // Initialize venue filters
        function initVenueFilters() {
            const filterChips = document.querySelectorAll('#search-filters .filter-chip');
            filterChips.forEach(chip => {
                const filterType = getFilterTypeFromChip(chip);
                chip.onclick = () => toggleVenueFilter(chip, filterType);
            });
            // Apply initial filters
            applyVenueFilters();
        }

        // Map chip text to filter type
        function getFilterTypeFromChip(chip) {
            const text = chip.textContent.trim().toLowerCase();
            if (text.includes('happening now')) return 'happening-now';
            if (text.includes('near me')) return 'near-me';
            if (text.includes('open now')) return 'open-now';
            if (text.includes('sports')) return 'sports-bars';
            if (text.includes('fine dining')) return 'fine-dining';
            if (text.includes('under $10')) return 'under-10';
            return text;
        }

        // Toggle a venue filter
        function toggleVenueFilter(chip, filterType) {
            if (activeVenueFilters.has(filterType)) {
                activeVenueFilters.delete(filterType);
                chip.classList.remove('active');
            } else {
                activeVenueFilters.add(filterType);
                chip.classList.add('active');
            }
            applyVenueFilters();
        }

        // Check if a venue (object) matches the active filters
        function venueMatchesFilters(venue, searchTerm = '') {
            if (!venue) return false;

            // Check search term match
            if (searchTerm.length > 0) {
                const nameMatch = venue.name.toLowerCase().includes(searchTerm);
                const typeMatch = (venue.type || '').toLowerCase().includes(searchTerm);
                if (!nameMatch && !typeMatch) return false;
            }

            // If no filters are active, show all venues (that match search)
            if (activeVenueFilters.size === 0) return true;

            // Check each active filter - venue must match ALL active filters
            for (const filter of activeVenueFilters) {
                if (!venueMatchesFilter(venue, filter)) {
                    return false;
                }
            }
            return true;
        }

        // Check if a venue (object) matches a specific filter
        function venueMatchesFilter(venue, filter) {
            switch (filter) {
                case 'happening-now':
                    // Check if happy hour is currently active
                    const hhStatus = calculateHappyHourStatus(venue.happyHourWeekly);
                    return hhStatus.status === 'on-now';

                case 'open-now':
                    // Check if business is currently open
                    const bizStatus = calculateBusinessHoursStatus(venue.hoursWeekly);
                    return bizStatus.isOpen === true;

                case 'sports-bars':
                    // Check venue type
                    return venue.type && venue.type.toLowerCase().includes('sports');

                case 'fine-dining':
                    // Check venue type - match "fine dining" or "upscale" venues
                    const venueType = (venue.type || '').toLowerCase();
                    return venueType.includes('fine dining') || venueType.includes('upscale');

                case 'under-10':
                    // Check if any specials mention prices under $10
                    const specials = (venue.specials || '').toLowerCase();
                    const specialsFood = (venue.specialsFood || []).join(' ').toLowerCase();
                    const specialsDrinks = (venue.specialsDrinks || []).join(' ').toLowerCase();
                    const allSpecials = specials + ' ' + specialsFood + ' ' + specialsDrinks;
                    // Look for prices $1-$9 (under $10)
                    return /\$[1-9](?:\.\d{2})?(?:\s|$|[^0-9])/.test(allSpecials);

                case 'near-me':
                    const dist = getVenueDistance(venue);
                    if (dist === null) return true; // No location data ‚Äî show all
                    return dist <= NEAR_ME_RADIUS_KM;

                default:
                    return true;
            }
        }

        // Get filtered venues from data model
        function getFilteredVenues(searchTerm = '') {
            return venuesData.filter(venue => venueMatchesFilters(venue, searchTerm));
        }

        // Apply venue filters to the list - re-renders from data model
        function applyVenueFilters() {
            const searchTerm = document.getElementById('search-input')?.value.toLowerCase() || '';

            // Get filtered venues from data model
            const filteredVenues = getFilteredVenues(searchTerm);

            // Re-render list view with filtered venues
            renderVenueListView(filteredVenues);

            // Re-render map view with filtered venues
            renderVenueMapView(filteredVenues);
        }

        // Search functionality - delegates to applyVenueFilters to combine search + filters
        function performSearch() {
            applyVenueFilters();
        }

        // Toggle favorites search visibility
        function toggleFavoritesSearch() {
            const searchContainer = document.getElementById('favorites-search-container');
            const searchToggleBtn = document.getElementById('favorites-search-toggle');
            const searchInput = document.getElementById('favorites-search-input');

            if (searchContainer.classList.contains('active')) {
                // Close search
                searchContainer.classList.remove('active');
                searchToggleBtn.textContent = 'üîç';
                searchInput.value = '';
                performFavoritesSearch(); // Reset filter
            } else {
                // Open search
                searchContainer.classList.add('active');
                searchToggleBtn.textContent = '‚úï';
                // Focus input after a brief delay to ensure it's visible
                setTimeout(() => searchInput.focus(), 100);
            }
        }

        // Favorites search functionality
        function performFavoritesSearch() {
            const searchTerm = document.getElementById('favorites-search-input').value.toLowerCase();
            const favoritesScreen = document.getElementById('favorites-screen');
            const listingItems = favoritesScreen.querySelectorAll('.listing-item');
            const eventItems = favoritesScreen.querySelectorAll('.event-item');
            const emptyState = document.getElementById('favorites-empty-state');

            if (searchTerm.length === 0) {
                listingItems.forEach(item => {
                    item.style.display = 'flex';
                });
                eventItems.forEach(item => {
                    item.style.display = 'block';
                });
                renderSavedPage();
                return;
            }

            let visibleCount = 0;

            // Filter venue listings
            listingItems.forEach(item => {
                const venueName = item.querySelector('.listing-name')?.textContent.toLowerCase() || '';
                if (venueName.includes(searchTerm)) {
                    item.style.display = 'flex';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });

            // Filter event listings
            eventItems.forEach(item => {
                const eventTitle = item.querySelector('.event-title')?.textContent.toLowerCase() || '';
                const eventVenue = item.querySelector('.event-venue')?.textContent.toLowerCase() || '';
                if (eventTitle.includes(searchTerm) || eventVenue.includes(searchTerm)) {
                    item.style.display = 'block';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });

            // Don't show empty state during search filtering - only when truly empty
            if (emptyState) {
                emptyState.style.display = 'none';
            }
        }

        // Get venue image based on type
        function getVenueImage(venue) {
            if (venue.type.includes('Fine Dining') || venue.type.includes('Upscale')) {
                return 'images/fine-dining-1.jpg';
            } else if (venue.type.includes('Sports Bar')) {
                return 'images/sports-bar-1.jpg';
            } else if (venue.type.includes('Casual')) {
                return 'images/casual-dining-2.jpg';
            } else {
                return 'images/casual-dining-1.jpg';
            }
        }

        // Get short specials text for listing card
        function getVenueShortSpecials(venue) {
            const food = venue.specialsFood?.[0] || '';
            const drinks = venue.specialsDrinks?.[0] || '';
            if (food && drinks) return `${food}, ${drinks}`;
            return food || drinks || 'Happy Hour Specials';
        }

        // Render the Saved page from central state
        function renderSavedPage() {
            const favoritesContent = document.getElementById('favorites-content');
            const emptyState = document.getElementById('favorites-empty-state');

            if (!favoritesContent) return;

            // Clear existing items (except empty state)
            const existingItems = favoritesContent.querySelectorAll('.listing-item, .event-item');
            existingItems.forEach(item => item.remove());

            const hasSavedVenues = savedVenues.size > 0;
            const hasSavedEvents = savedEvents.size > 0;
            const hasAnySaved = hasSavedVenues || hasSavedEvents;

            // Show/hide empty state
            if (emptyState) {
                emptyState.style.display = hasAnySaved ? 'none' : 'flex';
            }

            // Render saved venues (iterate over IDs, look up venue by ID)
            if (hasSavedVenues) {
                savedVenues.forEach(venueId => {
                    const venue = venuesById[venueId];
                    if (!venue) return;

                    const itemHtml = `
                        <div class="listing-item" data-venue-id="${venue.id}" onclick="showVenueDetail('${venue.name}')">
                            <div class="listing-image">
                                <img src="${getVenueImage(venue)}" alt="${venue.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                            </div>
                            <div class="listing-content">
                                <div class="listing-header">
                                    <div class="listing-name">${venue.name}</div>
                                    <button class="bookmark-icon saved" onclick="event.stopPropagation(); handleBookmarkClick(this)">
                                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                                        </svg>
                                    </button>
                                </div>
                                <div class="listing-offer">${getVenueShortSpecials(venue)}</div>
                                <div class="listing-meta">
                                    <span class="category-tag">‚Ä¢ ${venue.type}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    favoritesContent.insertAdjacentHTML('beforeend', itemHtml);
                });
            }

            // Render saved events (iterate over IDs, look up event by ID)
            if (hasSavedEvents) {
                savedEvents.forEach(eventId => {
                    const event = eventsById[eventId];
                    if (!event) return;

                    // Get venue name for the event
                    const eventVenue = getVenueForEvent(event);
                    const venueName = eventVenue ? eventVenue.name : 'Unknown Venue';

                    const itemHtml = `
                        <div class="event-item" data-event-id="${event.id}" onclick="showEventDetail('${event.name}')">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div>
                                    <div class="event-title">${event.name}</div>
                                    <div class="event-venue">${venueName}</div>
                                    <div class="event-time">${event.schedule} ${event.time}</div>
                                </div>
                                <button class="bookmark-icon saved" onclick="event.stopPropagation(); handleBookmarkClick(this)">
                                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                    favoritesContent.insertAdjacentHTML('beforeend', itemHtml);
                });
            }
        }

        // Legacy function - now calls renderSavedPage
        function checkFavoritesEmpty() {
            renderSavedPage();
        }

        // Filter collapse on scroll
        let lastScrollTop = 0;
        const searchScreen = document.getElementById('search-screen');
        const searchFilterSection = document.getElementById('search-filter-section');

        function handleSearchScroll() {
            const listContent = document.getElementById('list-content');
            const mapContent = document.getElementById('map-content');

            // Determine which content area is visible
            const activeContent = currentView === 'list' ? listContent : mapContent;

            if (!activeContent) return;

            const scrollTop = activeContent.scrollTop;

            // If scrolled to top (or very close), show filters
            if (scrollTop <= 10) {
                searchFilterSection.classList.remove('collapsed');
            } else {
                // If scrolling down, hide filters
                searchFilterSection.classList.add('collapsed');
            }

            lastScrollTop = scrollTop;
        }

        // Add search event listener
        // Update all listing cards with dynamic HH status
        function updateAllListingHHStatus() {
            document.querySelectorAll('.listing-item').forEach(card => {
                const venueName = card.querySelector('.listing-name')?.textContent;
                if (!venueName) return;

                // Remove old HH display elements
                const oldTimeRange = card.querySelector('.listing-time-range');
                const oldTimeRemaining = card.querySelector('.time-remaining');
                if (oldTimeRange) oldTimeRange.remove();
                if (oldTimeRemaining) oldTimeRemaining.remove();

                // Add new single HH status line
                const listingOffer = card.querySelector('.listing-offer');
                if (listingOffer) {
                    const hhStatusHTML = generateSearchHHStatusHTML(venueName);
                    if (hhStatusHTML) {
                        listingOffer.insertAdjacentHTML('afterend', hhStatusHTML);
                    }
                }
            });
        }

        // One-time horizontal peek animation for filter chips
        function showFilterSwipeHint(filterId, storageKey) {
            // Check if hint has already been shown
            if (sessionStorage.getItem(storageKey)) {
                return;
            }

            const filterContainer = document.getElementById(filterId);
            if (!filterContainer) return;

            // Only animate if there's horizontal overflow
            if (filterContainer.scrollWidth <= filterContainer.clientWidth + 1) {
                return;
            }

            // Wait a moment for layout to settle, then animate
            setTimeout(() => {
                const initialScroll = filterContainer.scrollLeft;
                const nudgeAmount = 16; // pixels to nudge right

                // Smoothly scroll right
                filterContainer.scrollTo({
                    left: initialScroll + nudgeAmount,
                    behavior: 'smooth'
                });

                // After a short pause, scroll back to start
                setTimeout(() => {
                    filterContainer.scrollTo({
                        left: initialScroll,
                        behavior: 'smooth'
                    });
                }, 400);

                // Mark hint as shown
                sessionStorage.setItem(storageKey, 'true');
            }, 300);
        }

        document.addEventListener('DOMContentLoaded', function() {
            // ===== LAUNCH SCREEN LOGIC =====
            // Determine if this is first launch or subsequent launch
            const hasLaunchedBefore = localStorage.getItem('hhc_has_launched');
            const splashScreen = document.getElementById('splash-screen');
            const homeScreen = document.getElementById('home-screen');
            const searchScreen = document.getElementById('search-screen');
            const homeCta = document.getElementById('home-cta-btn');

            function transitionToSearch() {
                // Hide splash/home screens
                if (splashScreen) splashScreen.classList.remove('active');
                if (homeScreen) homeScreen.classList.remove('active');
                // Show search screen
                if (searchScreen) searchScreen.classList.add('active');
            }

            if (!hasLaunchedBefore) {
                // First launch: show home screen with tagline and CTA
                if (homeScreen) homeScreen.classList.add('active');

                // Handle CTA click
                if (homeCta) {
                    homeCta.addEventListener('click', function() {
                        // Mark as launched
                        localStorage.setItem('hhc_has_launched', 'true');
                        // Transition to search
                        transitionToSearch();
                    });
                }
            } else {
                // Subsequent launch: show splash briefly, then search
                if (splashScreen) splashScreen.classList.add('active');

                // Brief splash display (1.5 seconds), then fade and show search
                setTimeout(function() {
                    if (splashScreen) {
                        splashScreen.classList.add('fade-out');
                        // After fade animation completes, transition to search
                        setTimeout(function() {
                            transitionToSearch();
                        }, 300); // Match the CSS transition duration
                    }
                }, 1200); // Splash visible for 1.2s before fade begins
            }

            // Migrate any legacy name-based saved items to ID-based
            migrateSavedStateToIds();

            // Capture user location for distance calculation
            // Renders happen immediately (distances blank until resolved),
            // then re-render once geolocation completes
            captureUserLocation().then(function() {
                renderVenueListView();
                renderVenueMapView();
                syncAllBookmarkIcons();
                updateAllListingHHStatus();
            });

            // Initialize the toggle icon
            const toggleIconSvg = document.getElementById('toggle-icon-svg');
            if (toggleIconSvg) {
                toggleIconSvg.innerHTML = mapPinIcon;
            }

            // Render initial venue lists from data model
            renderVenueListView();
            renderVenueMapView();

            // Render initial events list from data model
            renderEventsList();

            // Update all listing cards with dynamic HH status
            updateAllListingHHStatus();

            // Initialize venue filters (will also trigger applyVenueFilters)
            initVenueFilters();

            // Initialize saved state - sync all bookmark icons and render saved page
            syncAllBookmarkIcons();
            renderSavedPage();

            // Show one-time swipe hint for filter chips (if overflow exists)
            showFilterSwipeHint('search-filters', 'hhc_filters_swipe_hint_shown_search');
            showFilterSwipeHint('events-filters', 'hhc_filters_swipe_hint_shown_events');

            // Attach scroll listeners to both content areas
            const listContent = document.getElementById('list-content');
            const mapContent = document.getElementById('map-content');

            if (listContent) {
                listContent.addEventListener('scroll', handleSearchScroll);
            }
            if (mapContent) {
                mapContent.addEventListener('scroll', handleSearchScroll);
            }
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('input', performSearch);
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        performSearch();
                        this.blur(); // Dismiss keyboard on mobile
                    }
                });
            }

            // Favorites search listener
            const favoritesSearchInput = document.getElementById('favorites-search-input');
            if (favoritesSearchInput) {
                favoritesSearchInput.addEventListener('input', performFavoritesSearch);
                favoritesSearchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        performFavoritesSearch();
                        this.blur(); // Dismiss keyboard on mobile
                    }
                });
            }

            // Events search listener
            const eventsSearchInput = document.getElementById('events-search-input');
            if (eventsSearchInput) {
                eventsSearchInput.addEventListener('input', performEventsSearch);
                eventsSearchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        performEventsSearch();
                        this.blur(); // Dismiss keyboard on mobile
                    }
                });
            }
        });
    </script>
</body>
</html>
